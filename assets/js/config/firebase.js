/* ==========================================================================
   CONFIGURA√á√ÉO FIREBASE - Sistema de Gest√£o v5.1
   ========================================================================== */

/**
 * Configura√ß√£o do Firebase
 * IMPORTANTE: Estas s√£o suas credenciais atuais do Firebase
 */
const firebaseConfig = {
    apiKey: "AIzaSyCT0UXyU6AeurlaZdgM4_MKhzJWIdYxWg4",
    authDomain: "sistema-gestao-obra.firebaseapp.com",
    databaseURL: "https://sistema-gestao-obra-default-rtdb.firebaseio.com",
    projectId: "sistema-gestao-obra",
    storageBucket: "sistema-gestao-obra.firebasestorage.app",
    messagingSenderId: "686804029278",
    appId: "1:686804029278:web:758190822a19ef935e89cf",
    measurementId: "G-RE86WX5KY2"
};

/**
 * Inicializar Firebase e configurar refer√™ncias globais
 */
let database, auth;

/**
 * Fun√ß√£o para inicializar o Firebase
 * @returns {Object} Objeto com database e auth
 */
function initializeFirebase() {
    try {
        // Verificar se Firebase est√° dispon√≠vel
        if (typeof firebase === 'undefined') {
            console.error('‚ùå Firebase n√£o carregado! Verifique os scripts.');
            throw new Error('Firebase n√£o dispon√≠vel');
        }

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Configurar refer√™ncias globais
        database = firebase.database();
        auth = firebase.auth();
        
        console.log('‚úÖ Firebase inicializado com sucesso');
        console.log('üî• Projeto:', firebaseConfig.projectId);
        console.log('üåê Auth Domain:', firebaseConfig.authDomain);
        
        return { database, auth };
        
    } catch (error) {
        console.error('‚ùå Erro ao inicializar Firebase:', error);
        throw error;
    }
}

/**
 * Fun√ß√£o para obter refer√™ncia do database
 * @returns {Object} Firebase Database
 */
function getDatabase() {
    if (!database) {
        throw new Error('Database n√£o inicializado. Chame initializeFirebase() primeiro.');
    }
    return database;
}

/**
 * Fun√ß√£o para obter refer√™ncia do auth
 * @returns {Object} Firebase Auth
 */
function getAuth() {
    if (!auth) {
        throw new Error('Auth n√£o inicializado. Chame initializeFirebase() primeiro.');
    }
    return auth;
}

/**
 * Fun√ß√£o para verificar se Firebase est√° conectado
 * @returns {Promise<boolean>} Status da conex√£o
 */
function verificarConexaoFirebase() {
    return new Promise((resolve) => {
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snapshot) => {
            const connected = snapshot.val();
            console.log(connected ? 'üü¢ Firebase conectado' : 'üî¥ Firebase desconectado');
            resolve(connected);
        });
    });
}

/**
 * Fun√ß√£o para configurar listeners de conex√£o
 */
function configurarMonitoramentoConexao() {
    const connectedRef = database.ref('.info/connected');
    
    connectedRef.on('value', (snapshot) => {
        if (snapshot.val() === true) {
            console.log('üü¢ Conectado ao Firebase');
            // Atualizar UI se necess√°rio
            if (typeof atualizarIndicadorSync === 'function') {
                atualizarIndicadorSync('synced');
            }
        } else {
            console.log('üî¥ Desconectado do Firebase');
            // Atualizar UI se necess√°rio
            if (typeof atualizarIndicadorSync === 'function') {
                atualizarIndicadorSync('offline');
            }
        }
    });
}

/**
 * Fun√ß√£o para obter informa√ß√µes do Firebase
 * @returns {Object} Informa√ß√µes do projeto
 */
function getFirebaseInfo() {
    return {
        projectId: firebaseConfig.projectId,
        authDomain: firebaseConfig.authDomain,
        databaseURL: firebaseConfig.databaseURL,
        version: '9.22.0',
        inicializado: !!database && !!auth
    };
}

/**
 * Fun√ß√£o para limpar listeners do Firebase
 */
function limparListenersFirebase() {
    try {
        if (database) {
            // Remover listeners de conex√£o
            database.ref('.info/connected').off();
            console.log('üßπ Listeners Firebase removidos');
        }
    } catch (error) {
        console.error('‚ùå Erro ao limpar listeners:', error);
    }
}

/**
 * Fun√ß√£o para debug do Firebase
 */
function debugFirebase() {
    console.group('üî• DEBUG FIREBASE');
    console.log('Config:', firebaseConfig);
    console.log('Database:', !!database);
    console.log('Auth:', !!auth);
    console.log('Usu√°rio logado:', auth?.currentUser?.email || 'Nenhum');
    console.groupEnd();
}

// Exportar para uso global (compatibilidade)
if (typeof window !== 'undefined') {
    window.firebaseConfig = firebaseConfig;
    window.initializeFirebase = initializeFirebase;
    window.getDatabase = getDatabase;
    window.getAuth = getAuth;
    window.verificarConexaoFirebase = verificarConexaoFirebase;
    window.configurarMonitoramentoConexao = configurarMonitoramentoConexao;
    window.getFirebaseInfo = getFirebaseInfo;
    window.limparListenersFirebase = limparListenersFirebase;
    window.debugFirebase = debugFirebase;
}
/**
 * ========== INICIALIZA√á√ÉO AUTOM√ÅTICA ==========
 */

// Aguardar que o DOM esteja pronto e ent√£o inicializar o Firebase
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        try {
            initializeFirebase();
        } catch (error) {
            console.error('‚ùå Erro na inicializa√ß√£o autom√°tica do Firebase:', error);
        }
    });
} else {
    // DOM j√° carregado - inicializar imediatamente
    try {
        initializeFirebase();
    } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o autom√°tica do Firebase:', error);
    }
}
/**
 * CORRE√á√ÉO FIREBASE - Adicionar ao final do assets/js/config/firebase.js
 * Para garantir compatibilidade com o c√≥digo original
 */

// ========== COMPATIBILIDADE COM C√ìDIGO ORIGINAL ==========

/**
 * Aguardar Firebase estar totalmente carregado e ent√£o configurar vari√°veis globais
 */
function aguardarFirebaseEConfigurar() {
    return new Promise((resolve, reject) => {
        let tentativas = 0;
        const maxTentativas = 10;
        
        function verificarFirebase() {
            tentativas++;
            
            if (typeof firebase !== 'undefined' && 
                firebase.apps && 
                firebase.apps.length > 0) {
                
                // Firebase carregado e inicializado
                try {
                    // Configurar vari√°veis globais para compatibilidade
                    window.database = firebase.database();
                    window.auth = firebase.auth();
                    
                    console.log('‚úÖ Firebase configurado globalmente');
                    console.log('üì° Database:', !!window.database);
                    console.log('üîê Auth:', !!window.auth);
                    
                    resolve(true);
                } catch (error) {
                    console.error('‚ùå Erro ao configurar Firebase globalmente:', error);
                    reject(error);
                }
            } else if (tentativas < maxTentativas) {
                // Tentar novamente em 100ms
                setTimeout(verificarFirebase, 100);
            } else {
                // Excesso de tentativas
                reject(new Error('Firebase n√£o carregou ap√≥s m√∫ltiplas tentativas'));
            }
        }
        
        verificarFirebase();
    });
}

/**
 * Inicializa√ß√£o segura com retry
 */
function inicializarFirebaseSafe() {
    aguardarFirebaseEConfigurar()
        .then(() => {
            console.log('üéâ Firebase totalmente pronto!');
            
            // Configurar monitoramento de conex√£o
            if (typeof configurarMonitoramentoConexao === 'function') {
                configurarMonitoramentoConexao();
            }
            
            // Disparar evento personalizado para avisar que Firebase est√° pronto
            window.dispatchEvent(new CustomEvent('firebaseReady'));
        })
        .catch(error => {
            console.error('üí• Falha cr√≠tica na inicializa√ß√£o do Firebase:', error);
            
            // Mostrar erro para o usu√°rio
            if (typeof mostrarNotificacao === 'function') {
                mostrarNotificacao('Erro ao conectar com o servidor!', 'error');
            } else {
                alert('Erro ao conectar com o servidor! Verifique sua conex√£o.');
            }
        });
}

// ========== SUBSTITUIR INICIALIZA√á√ÉO AUTOM√ÅTICA ==========

// Remover a inicializa√ß√£o autom√°tica anterior e usar a nova
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializarFirebaseSafe);
} else {
    // DOM j√° carregado
    setTimeout(inicializarFirebaseSafe, 100); // Pequeno delay para garantir que scripts carregaram
}

console.log('üîß Firebase configurado com inicializa√ß√£o segura');

// ========== FUN√á√ÉO DE DIAGN√ìSTICO ==========

/**
 * Fun√ß√£o para diagnosticar problemas do Firebase
 */
function diagnosticarFirebase() {
    console.group('üî• DIAGN√ìSTICO FIREBASE');
    
    // Verificar se scripts CDN carregaram
    console.log('Firebase Global:', typeof firebase !== 'undefined' ? '‚úÖ' : '‚ùå');
    
    if (typeof firebase !== 'undefined') {
        console.log('Firebase Apps:', firebase.apps?.length || 0);
        console.log('SDK Version:', firebase.SDK_VERSION || 'N√£o detectada');
    }
    
    // Verificar vari√°veis globais
    console.log('window.database:', !!window.database ? '‚úÖ' : '‚ùå');
    console.log('window.auth:', !!window.auth ? '‚úÖ' : '‚ùå');
    
    // Verificar configura√ß√£o
    console.log('Config v√°lida:', !!firebaseConfig.apiKey ? '‚úÖ' : '‚ùå');
    
    // Status de conex√£o
    if (window.database) {
        window.database.ref('.info/connected').once('value')
            .then(snapshot => {
                console.log('Conex√£o ativa:', snapshot.val() ? '‚úÖ' : '‚ùå');
            })
            .catch(error => {
                console.log('Erro de conex√£o:', error.message);
            });
    }
    
    console.groupEnd();
}

// Exportar fun√ß√£o de diagn√≥stico
window.diagnosticarFirebase = diagnosticarFirebase;

// Executar diagn√≥stico ap√≥s 2 segundos (para debug)
if (window.DEBUG && window.DEBUG.ENABLED) {
    setTimeout(diagnosticarFirebase, 2000);
}
console.log('üî• Firebase configurado para inicializa√ß√£o autom√°tica');
 
