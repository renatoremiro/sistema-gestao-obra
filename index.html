<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o Completo - Obra 292 (Firebase v5.1)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f3f4f6;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Sistema de Login */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .login-container h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #1f2937;
        }
        
        /* Indicador de Sincroniza√ß√£o */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            transition: all 0.3s;
        }
        
        .sync-indicator.syncing {
            background: #fbbf24;
        }
        
        .sync-indicator.synced {
            background: #10b981;
            color: white;
        }
        
        .sync-indicator.error {
            background: #ef4444;
            color: white;
        }
        
        .sync-indicator.offline {
            background: #6b7280;
            color: white;
        }
        
        /* Indicador de Usu√°rios Online */
        .users-online {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .users-online-list {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            position: relative;
        }
        
        .user-avatar.online::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background: #10b981;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .user-tooltip {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        
        .user-avatar:hover .user-tooltip {
            opacity: 1;
        }
        
        /* Indicador de Edi√ß√£o */
        .editing-indicator {
            background: #fbbf24;
            color: #1f2937;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Log de Atividades */
        .activity-log {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            max-height: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            transform: translateX(320px);
            transition: transform 0.3s;
            z-index: 900;
        }
        
        .activity-log.active {
            transform: translateX(0);
        }
        
        .activity-log-header {
            background: #1f2937;
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .activity-log-content {
            max-height: 340px;
            overflow-y: auto;
            padding: 12px;
        }
        
        .activity-item {
            padding: 8px;
            margin-bottom: 8px;
            background: #f9fafb;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .activity-item .time {
            font-size: 11px;
            color: #6b7280;
        }
        
        .activity-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #3b82f6;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 899;
        }
        
        /* Conflitos de Edi√ß√£o */
        .conflict-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 2000;
            max-width: 500px;
            display: none;
        }
        
        .conflict-modal.active {
            display: block;
        }
        
        .conflict-options {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        /* Todos os estilos originais do sistema */
        .header {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .breadcrumb {
            background: #e5e7eb;
            padding: 8px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        
        .breadcrumb span {
            color: #6b7280;
        }
        
        .breadcrumb a {
            color: #3b82f6;
            text-decoration: none;
            cursor: pointer;
        }
        
        .card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }
        
        .status-verde { background: #10b981; }
        .status-amarelo { background: #f59e0b; }
        .status-vermelho { background: #ef4444; }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .calendario {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 20px;
        }
        
        .dia {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 8px;
            min-height: 100px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: visible;
        }
        
        .dia:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .dia-feriado {
            background: #fef3c7;
            border-color: #f59e0b;
        }
        
        .dia-header {
            background: #1f2937;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            border-radius: 8px;
        }
        
        .dia-numero {
            font-weight: bold;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .feriado-label {
            font-size: 10px;
            background: #f59e0b;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .evento {
            background: #3b82f6;
            color: white;
            padding: 4px 6px;
            border-radius: 4px;
            margin-top: 4px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 2px;
            position: relative;
            transition: all 0.2s;
            user-select: none;
        }
        
        .evento:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .evento:hover::before {
            content: '‚úèÔ∏è';
            position: absolute;
            right: -20px;
            top: 0;
            opacity: 0.7;
            font-size: 12px;
        }
        
        .evento-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 4px;
        }
        
        .evento-info {
            font-size: 9px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .evento-reuniao { background: #3b82f6; }
        .evento-entrega { background: #10b981; }
        .evento-prazo { background: #ef4444; }
        .evento-marco { background: #8b5cf6; }
        .evento-outro { background: #6b7280; }
        
        .evento-dia-completo {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            margin: 2px -4px;
            padding: 6px 8px;
        }
        
        .evento-multi-dia {
            border-left: 3px solid #1e40af;
            background: linear-gradient(to right, #3b82f6, #60a5fa);
        }
        
        .hidden {
            display: none !important;
        }
        
        .area-card {
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .area-card:hover {
            transform: translateY(-4px);
            border-color: #3b82f6;
        }
        
        .back-btn {
            color: #3b82f6;
            cursor: pointer;
            margin-bottom: 16px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }
        
        .resumo-box {
            text-align: center;
            padding: 24px;
            border-radius: 12px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
        }
        
        .resumo-numero {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }
        
        .notification.active {
            display: flex;
        }
        
        .notification.error {
            background: #ef4444;
        }
        
        .notification.warning {
            background: #f59e0b;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .search-box input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
        }
        
        .filter-pills {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .filter-pill {
            padding: 6px 16px;
            border-radius: 20px;
            background: #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .filter-pill.active {
            background: #3b82f6;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s;
        }
        
        .agenda-semana {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-top: 20px;
        }
        
        .dia-semana {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            min-height: 200px;
        }
        
        .tarefa {
            background: #f3f4f6;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .tarefa:hover {
            background: #e5e7eb;
        }
        
        .tarefa .delete-btn,
        .tarefa .edit-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .tarefa:hover .delete-btn,
        .tarefa:hover .edit-btn {
            opacity: 1;
        }
        
        .tarefa-global {
            background: #ddd6fe;
            border: 1px solid #a78bfa;
        }
        
        .tarefa-recorrente {
            background: #d1fae5;
            border: 1px solid #6ee7b7;
        }
        
        .status-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: #1f2937;
            color: white;
        }
        
        .status-ausencia {
            background: #ef4444;
        }
        
        .status-home-office {
            background: #3b82f6;
        }
        
        .delete-btn {
            color: #ef4444;
            cursor: pointer;
            font-size: 12px;
            float: right;
            padding: 0 4px;
            margin-left: 8px;
            z-index: 10;
        }
        
        .delete-btn:hover {
            color: #dc2626;
            font-weight: bold;
        }
        
        .edit-btn {
            color: #3b82f6;
            cursor: pointer;
            font-size: 12px;
            margin-right: 8px;
        }
        
        .checkbox-group {
            display: flex;
            gap: 16px;
            margin-top: 8px;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* Melhorias de responsividade */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .calendario {
                grid-template-columns: repeat(7, 1fr);
                gap: 4px;
            }
            
            .dia {
                min-height: 60px;
                padding: 4px;
                font-size: 12px;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .agenda-semana {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 20px;
            }
        }
        
        /* Indicadores de valida√ß√£o */
        .input-error {
            border-color: #ef4444 !important;
        }
        
        .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
        }
        
        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f4f6;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Tooltips */
        .tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
        }
        
        /* Estilos para sistema de tarefas */
        .tarefas-container {
            margin-top: 16px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .tarefa-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }
        
        .tarefa-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .tarefa-header {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .tarefa-expandir {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s;
        }
        
        .tarefa-expandir.expandido {
            transform: rotate(90deg);
        }
        
        .tarefa-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .tarefa-descricao {
            flex: 1;
            font-weight: 500;
        }
        
        .tarefa-descricao.concluida {
            text-decoration: line-through;
            color: #9ca3af;
        }
        
        .tarefa-info {
            display: flex;
            gap: 12px;
            align-items: center;
            font-size: 12px;
            color: #6b7280;
        }
        
        .subtarefas-container {
            margin-left: 32px;
            margin-top: 12px;
            padding-left: 16px;
            border-left: 2px solid #e5e7eb;
        }
        
        .subtarefa-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            margin-bottom: 4px;
            background: #f9fafb;
            border-radius: 4px;
        }
        
        .subtarefa-item:hover {
            background: #f3f4f6;
        }
        
        .prioridade-alta {
            color: #ef4444;
            font-weight: 500;
        }
        
        .prioridade-media {
            color: #f59e0b;
            font-weight: 500;
        }
        
        .prioridade-baixa {
            color: #10b981;
            font-weight: 500;
        }
        
        .dependencia-bloqueada {
            opacity: 0.6;
            position: relative;
        }
        
        .dependencia-bloqueada::before {
            content: 'üîí';
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .adicionar-tarefa-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: #3b82f6;
            color: white;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .adicionar-tarefa-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .contador-tarefas {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 12px;
            border-radius: 20px;
        }
        
        .btn-template {
            background: #8b5cf6;
            color: white;
        }
        
        .btn-template:hover {
            background: #7c3aed;
        }
        
        /* Estilos para campos de recorr√™ncia */
        .recorrencia-config {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-top: 12px;
            border: 1px solid #e5e7eb;
        }
        
        .recorrencia-config.hidden {
            display: none;
        }
        
        /* Estilos para sele√ß√£o m√∫ltipla de pessoas */
        .pessoas-selecionadas {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .pessoa-chip {
            background: #e5e7eb;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .pessoa-chip .remove {
            cursor: pointer;
            color: #6b7280;
            font-weight: bold;
        }
        
        .pessoa-chip .remove:hover {
            color: #ef4444;
        }
        
        /* Estilos para tarefas vinculadas */
        .tarefas-vinculadas {
            margin-top: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .tarefa-vinculo {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            margin-bottom: 4px;
            background: white;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .tarefa-vinculo:hover {
            background: #f3f4f6;
        }
        
        /* Indicador de evento recorrente */
        .recorrente-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            opacity: 0.8;
        }
        
        /* Estilos para eventos de m√∫ltiplos dias */
        .evento-duracao {
            font-size: 9px;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        /* Timeline de eventos */
        .timeline-container {
            margin-top: 24px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .timeline-item {
            position: relative;
            padding-left: 32px;
            margin-bottom: 24px;
            border-left: 2px solid #e5e7eb;
        }
        
        .timeline-item:last-child {
            border-left: none;
        }
        
        .timeline-marker {
            position: absolute;
            left: -8px;
            top: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: white;
            border: 3px solid #3b82f6;
        }
        
        .timeline-content {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
        }
        
        /* Estilos para hor√°rio de in√≠cio e fim */
        .horario-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .horario-group .form-group {
            margin-bottom: 0;
        }

        /* Alertas de prazo */
        .alerta-prazo {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 300px;
            z-index: 1500;
            animation: slideIn 0.3s ease-out;
        }

        .alerta-prazo.warning {
            background: #f59e0b;
        }

        .alerta-prazo .close-btn {
            float: right;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
        }

        /* Modal de editar tarefa */
        .modal-editar-tarefa {
            max-width: 600px;
        }

        .prazo-invalido {
            background: #fee2e2;
            border-color: #ef4444;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container">
        <h2>üèóÔ∏è Sistema de Gest√£o</h2>
        <p style="text-align: center; color: #6b7280; margin-bottom: 24px;">Obra 292 - Museu Nacional</p>
        
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="loginEmail" placeholder="seu@email.com">
        </div>
        
        <div class="form-group">
            <label>Senha</label>
            <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        
        <button class="btn btn-primary" style="width: 100%;" onclick="fazerLogin()">
            Entrar
        </button>
        
        <div style="margin-top: 16px; text-align: center;">
            <a href="#" onclick="mostrarRegistro()" style="color: #3b82f6; text-decoration: none;">
                N√£o tem conta? Registre-se
            </a>
        </div>
    </div>
    
    <!-- Indicador de Sincroniza√ß√£o -->
    <div id="syncIndicator" class="sync-indicator synced">
        <span class="loading" id="syncLoader" style="display: none;"></span>
        <span id="syncText">‚úì Sincronizado</span>
    </div>
    
    <!-- Indicador de Usu√°rios Online -->
    <div id="usersOnline" class="users-online hidden">
        <div style="font-size: 13px; color: #6b7280;">Equipe Online</div>
        <div class="users-online-list" id="usersOnlineList"></div>
    </div>
    
    <!-- Log de Atividades -->
    <div class="activity-toggle" onclick="toggleActivityLog()">
        üìã Atividades
    </div>
    
    <div id="activityLog" class="activity-log">
        <div class="activity-log-header">
            <span>Atividades Recentes</span>
            <span style="cursor: pointer;" onclick="toggleActivityLog()">‚úï</span>
        </div>
        <div class="activity-log-content" id="activityLogContent">
            <!-- Atividades ser√£o inseridas aqui -->
        </div>
    </div>
    
    <!-- Modal de Conflito -->
    <div id="conflictModal" class="conflict-modal">
        <h3>‚ö†Ô∏è Conflito de Edi√ß√£o</h3>
        <p id="conflictMessage"></p>
        <div class="conflict-options">
            <button class="btn btn-primary" onclick="resolverConflito('manter')">
                Manter Minhas Altera√ß√µes
            </button>
            <button class="btn btn-secondary" onclick="resolverConflito('descartar')">
                Usar Vers√£o do Servidor
            </button>
        </div>
    </div>
    
    <!-- Sistema de Notifica√ß√µes -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>
    
    <div class="container" id="mainContainer" class="hidden">
        <!-- Breadcrumb de Navega√ß√£o -->
        <div id="breadcrumb" class="breadcrumb hidden">
            <span id="breadcrumbPath"></span>
        </div>
        
        <div class="header">
            <div>
                <h1>Sistema de Gest√£o Colaborativo</h1>
                <p>Obra 292 - Museu Nacional</p>
                <p style="font-size: 14px; color: #6b7280;">
                    Sistema v5.1 Firebase - Melhorias Avan√ßadas üöÄ
                    <span id="usuarioInfo" style="margin-left: 16px; font-weight: bold;"></span>
                </p>
            </div>
            <div style="text-align: right;">
                <p id="dataAtual" style="color: #6b7280;"></p>
                <p style="font-weight: bold;">
                    <span id="mesAno">Julho 2025</span>
                </p>
                <div style="margin-top: 8px;">
                    <button class="btn btn-success btn-sm" onclick="exportarDados()">
                        üì• Exportar
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="mostrarImportar()">
                        üì§ Importar
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="mostrarMarcarFeriado()">
                        üéâ Feriados
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="fazerLogout()">
                        üö™ Sair
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Executivo -->
        <div id="dashboardExecutivo">
            <!-- Estat√≠sticas R√°pidas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="resumo-numero" style="color: #10b981;" id="statEmDia">0</div>
                    <div>Em Dia</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressEmDia" style="background: #10b981;"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="resumo-numero" style="color: #f59e0b;" id="statAtencao">0</div>
                    <div>Aten√ß√£o</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressAtencao" style="background: #f59e0b;"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="resumo-numero" style="color: #ef4444;" id="statAtraso">0</div>
                    <div>Atraso</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressAtraso" style="background: #ef4444;"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="resumo-numero" style="color: #8b5cf6;" id="statEventos">0</div>
                    <div>Eventos no M√™s</div>
                </div>
            </div>
            
            <!-- Calend√°rio -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üìÖ Calend√°rio da Equipe</h3>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary btn-sm" onclick="mudarMes(-1)">‚óÄ Anterior</button>
                        <button class="btn btn-primary btn-sm" onclick="mostrarNovoEvento()">+ Novo Evento</button>
                        <button class="btn btn-secondary btn-sm" onclick="mudarMes(1)">Pr√≥ximo ‚ñ∂</button>
                    </div>
                </div>
                
                <div id="calendario" class="calendario"></div>
                
                <div style="margin-top: 16px; display: flex; gap: 16px; flex-wrap: wrap; font-size: 12px;">
                    <span><span class="status-indicator evento-reuniao"></span>Reuni√£o</span>
                    <span><span class="status-indicator evento-entrega"></span>Entrega</span>
                    <span><span class="status-indicator evento-prazo"></span>Prazo</span>
                    <span><span class="status-indicator evento-marco"></span>Marco</span>
                    <span><span class="status-indicator evento-outro"></span>Outros</span>
                    <span><span class="status-indicator" style="background: #f59e0b;"></span>Feriado</span>
                    <span>üîÑ Evento Recorrente</span>
                </div>
            </div>
            
            <!-- Timeline de Pr√≥ximos Eventos -->
            <div class="timeline-container">
                <h3 style="margin-bottom: 20px;">üìç Pr√≥ximos Eventos Importantes</h3>
                <div id="timelineEventos"></div>
            </div>
            
            <!-- Busca e Filtros -->
            <div class="card">
                <h3 style="margin-bottom: 16px;">üîç Busca e Filtros</h3>
                <div class="search-box">
                    <input type="text" placeholder="Buscar atividades, pessoas, eventos..." id="searchInput" onkeyup="buscarGlobalDebounced()">
                    <button class="btn btn-primary" onclick="buscarGlobal()">Buscar</button>
                </div>
                <div class="filter-pills">
                    <div class="filter-pill active" onclick="filtrarStatus('todos', this)">Todos</div>
                    <div class="filter-pill" onclick="filtrarStatus('verde', this)">Em Dia</div>
                    <div class="filter-pill" onclick="filtrarStatus('amarelo', this)">Aten√ß√£o</div>
                    <div class="filter-pill" onclick="filtrarStatus('vermelho', this)">Atraso</div>
                </div>
            </div>
            
            <!-- Dica do sistema -->
            <div style="background: #dbeafe; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; color: #1e40af;">
                <strong>üî• Sistema v5.1 - Novas Funcionalidades:</strong> 
                <br><strong>‚úÖ Edi√ß√£o Completa de Tarefas:</strong> Agora voc√™ pode editar descri√ß√£o, prioridade e depend√™ncias
                <br><strong>‚ö†Ô∏è Valida√ß√£o de Prazos:</strong> Sistema bloqueia cria√ß√£o de atividades com prazo no passado
                <br><strong>üìä Progresso Autom√°tico:</strong> Calculado automaticamente baseado nas tarefas conclu√≠das
                <br><strong>üîî Alertas Inteligentes:</strong> Notifica√ß√µes autom√°ticas para prazos vencendo
                <br><strong>‚è∞ Monitoramento 24/7:</strong> Sistema verifica automaticamente status das atividades
                <br><strong>üì± Ainda mais responsivo:</strong> Funciona perfeitamente em qualquer dispositivo!
            </div>
            
            <!-- Cards das √Åreas -->
            <div class="grid" id="areasGrid"></div>
        </div>
        
        <!-- Painel de √Årea -->
        <div id="painelArea" class="hidden">
            <span class="back-btn" onclick="voltarDashboard()">‚Üê Voltar ao Dashboard</span>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 id="areaNome">Nome da √Årea</h2>
                        <p id="areaCoordenador" style="color: #6b7280;">Coordenador</p>
                    </div>
                    <button class="btn btn-primary" onclick="mostrarNovaAtividade()">+ Nova Atividade</button>
                </div>
            </div>
            
            <div class="grid">
                <div class="card">
                    <h3>üë• Equipe</h3>
                    <div id="equipeLista"></div>
                </div>
                
                <div class="card">
                    <h3>üìã Atividades em Andamento</h3>
                    <div id="atividadesLista"></div>
                </div>
            </div>
        </div>
        
        <!-- Agenda Individual -->
        <div id="agendaIndividual" class="hidden">
            <span class="back-btn" onclick="voltarParaArea()">‚Üê Voltar para √Årea</span>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 id="pessoaNome">Nome da Pessoa</h2>
                        <p id="pessoaCargo" style="color: #6b7280;">Cargo</p>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="mostrarNovaTarefa()">+ Nova Tarefa</button>
                        <button class="btn btn-warning btn-sm" onclick="mostrarMarcarStatus()">üìç Status Di√°rio</button>
                    </div>
                </div>
            </div>
            
            <div class="grid">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>üìä Minhas Responsabilidades</h3>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span id="contadorResponsabilidades" style="background: #e5e7eb; padding: 4px 12px; border-radius: 20px; font-size: 14px;">0</span>
                            <button class="btn btn-success btn-sm" onclick="mostrarAdicionarResponsabilidade()" title="Buscar novas responsabilidades">
                                + Adicionar
                            </button>
                        </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <select id="filtroResponsabilidades" onchange="renderizarResponsabilidades(estadoSistema.pessoaAtual)" 
                                style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                            <option value="todas">üîç Todas as responsabilidades</option>
                            <option value="urgentes">‚ö° Urgentes (‚â§ 3 dias)</option>
                            <option value="emdia">‚úÖ Em dia</option>
                            <option value="atencao">‚ö†Ô∏è Aten√ß√£o</option>
                            <option value="atrasadas">‚ùå Atrasadas</option>
                        </select>
                    </div>
                    <div id="responsabilidadesLista"></div>
                </div>
                
                <div class="card">
                    <h3>üìÖ Agenda da Semana</h3>
                    <div class="agenda-semana" id="agendaSemana"></div>
                </div>
            </div>
            
            <div class="card">
                <h3>üìù Observa√ß√µes Pessoais</h3>
                <textarea id="observacoesPessoais" rows="3" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px;" 
                    placeholder="Adicione suas observa√ß√µes..." onblur="salvarObservacoes()"></textarea>
            </div>
        </div>
    </div>
    
    <!-- Modal de Novo/Editar Evento (Atualizado) -->
    <div id="modalEvento" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 style="margin-bottom: 24px;" id="modalEventoTitulo">Novo Evento</h3>
            <input type="hidden" id="eventoId">
            
            <div class="form-group">
                <label>Tipo de Evento <span style="color: #ef4444;">*</span></label>
                <select id="eventoTipo" onchange="atualizarCamposEvento()">
                    <option value="reuniao">üìÖ Reuni√£o</option>
                    <option value="entrega">üì¶ Entrega</option>
                    <option value="prazo">‚è∞ Prazo</option>
                    <option value="marco">üéØ Marco do Projeto</option>
                    <option value="outro">üìå Outro (visita, auditoria, etc)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>T√≠tulo <span style="color: #ef4444;">*</span></label>
                <input type="text" id="eventoTitulo" placeholder="Digite o t√≠tulo do evento" required>
                <span class="error-message hidden" id="eventoTituloError">T√≠tulo √© obrigat√≥rio</span>
            </div>
            
            <div class="form-group">
                <label>Descri√ß√£o</label>
                <textarea id="eventoDescricao" rows="3" placeholder="Adicione uma descri√ß√£o detalhada..."></textarea>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="eventoDiaCompleto" onchange="toggleHorarios()">
                    Evento de dia completo
                </label>
            </div>
            
            <div class="form-group">
                <label>Data <span style="color: #ef4444;">*</span></label>
                <input type="date" id="eventoData" required>
                <span class="error-message hidden" id="eventoDataError">Data √© obrigat√≥ria</span>
            </div>
            
            <div class="form-group" id="grupoDataFim" style="display: none;">
                <label>Data de T√©rmino</label>
                <input type="date" id="eventoDataFim">
                <small style="color: #6b7280;">Para eventos de m√∫ltiplos dias</small>
            </div>
            
            <div class="horario-group" id="grupoHorarios">
                <div class="form-group">
                    <label>Hor√°rio In√≠cio <span style="color: #ef4444;">*</span></label>
                    <input type="time" id="eventoHorarioInicio" value="09:00" required>
                    <span class="error-message hidden" id="eventoHorarioInicioError">Hor√°rio √© obrigat√≥rio</span>
                </div>
                <div class="form-group">
                    <label>Hor√°rio Fim</label>
                    <input type="time" id="eventoHorarioFim" value="10:00">
                </div>
            </div>
            
            <div class="form-group" id="grupoLocal">
                <label>Local</label>
                <input type="text" id="eventoLocal" placeholder="Ex: Sala de reuni√£o, Canteiro de obras...">
            </div>
            
            <div class="form-group">
                <label id="labelPessoas">Participantes</label>
                <select id="eventoPessoas" onchange="adicionarPessoa()">
                    <option value="">Selecionar pessoa...</option>
                </select>
                <div class="pessoas-selecionadas" id="pessoasSelecionadas"></div>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="eventoRecorrente" onchange="toggleRecorrencia()">
                    Evento recorrente
                </label>
            </div>
            
            <div class="recorrencia-config hidden" id="recorrenciaConfig">
                <div class="form-group">
                    <label>Tipo de Recorr√™ncia</label>
                    <select id="recorrenciaTipo" onchange="atualizarConfigRecorrencia()">
                        <option value="diaria">Di√°ria</option>
                        <option value="semanal">Semanal</option>
                        <option value="quinzenal">Quinzenal</option>
                        <option value="mensal">Mensal</option>
                        <option value="bimestral">Bimestral</option>
                        <option value="personalizada">Personalizada</option>
                    </select>
                </div>
                
                <div class="form-group hidden" id="grupoDiasSemana">
                    <label>Dias da Semana</label>
                    <div class="checkbox-group" style="flex-direction: column; gap: 8px;">
                        <label><input type="checkbox" value="0"> Domingo</label>
                        <label><input type="checkbox" value="1"> Segunda</label>
                        <label><input type="checkbox" value="2"> Ter√ßa</label>
                        <label><input type="checkbox" value="3"> Quarta</label>
                        <label><input type="checkbox" value="4"> Quinta</label>
                        <label><input type="checkbox" value="5"> Sexta</label>
                        <label><input type="checkbox" value="6"> S√°bado</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>At√© quando?</label>
                    <input type="date" id="recorrenciaFim">
                    <small style="color: #6b7280;">Deixe vazio para continuar indefinidamente</small>
                </div>
            </div>
            
            <div class="form-group">
                <label>Vincular a Tarefas</label>
                <button type="button" class="btn btn-secondary btn-sm" onclick="abrirSeletorTarefas()">
                    + Selecionar Tarefas
                </button>
                <div class="tarefas-vinculadas" id="tarefasVinculadas"></div>
            </div>
            
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="fecharModal('modalEvento')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarEvento()" id="btnSalvarEvento">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Nova/Editar Atividade -->
    <div id="modalAtividade" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 24px;" id="modalAtividadeTitulo">Nova Atividade</h3>
            <input type="hidden" id="atividadeId">
            <div class="form-group">
                <label>Nome da Atividade <span style="color: #ef4444;">*</span></label>
                <input type="text" id="atividadeNome" placeholder="Digite o nome da atividade" required>
                <span class="error-message hidden" id="atividadeNomeError">Nome √© obrigat√≥rio</span>
            </div>
            <div class="form-group">
                <label>Prazo <span style="color: #ef4444;">*</span></label>
                <input type="date" id="atividadePrazo" required onchange="validarPrazoAtividade()">
                <span class="error-message hidden" id="atividadePrazoError">Prazo √© obrigat√≥rio</span>
                <span class="error-message hidden" id="atividadePrazoPassadoError">‚ö†Ô∏è Prazo n√£o pode ser no passado!</span>
            </div>
            <div class="form-group">
                <label>Respons√°veis <span style="color: #ef4444;">*</span></label>
                <select id="atividadeResponsaveis" multiple style="height: 100px;" required></select>
                <small style="color: #6b7280;">Segure Ctrl para selecionar m√∫ltiplos</small>
                <span class="error-message hidden" id="atividadeResponsaveisError">Selecione ao menos um respons√°vel</span>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="atividadeStatus">
                    <option value="verde">üü¢ Em Dia</option>
                    <option value="amarelo">üü° Aten√ß√£o</option>
                    <option value="vermelho">üî¥ Atraso</option>
                </select>
            </div>
            <div class="form-group">
                <label>Progresso (%) <span class="tooltip" data-tooltip="Calculado automaticamente pelas tarefas">‚ÑπÔ∏è</span></label>
                <input type="number" id="atividadeProgresso" min="0" max="100" placeholder="Calculado automaticamente" readonly 
                       style="background: #f9fafb; cursor: not-allowed;">
                <small style="color: #6b7280;">O progresso √© calculado automaticamente baseado nas tarefas conclu√≠das</small>
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="fecharModal('modalAtividade')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarAtividade()" id="btnSalvarAtividade">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Nova Tarefa -->
    <div id="modalTarefa" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 24px;">Nova Tarefa Pessoal</h3>
            <div class="form-group">
                <label>Tipo de Agendamento</label>
                <select id="tarefaTipo" onchange="alternarTipoAgendamento()">
                    <option value="semanal">Dia da Semana</option>
                    <option value="data">Data Espec√≠fica</option>
                </select>
            </div>
            <div class="form-group" id="grupoDiaSemana">
                <label>Dia da Semana</label>
                <select id="tarefaDia">
                    <option value="segunda">Segunda-feira</option>
                    <option value="terca">Ter√ßa-feira</option>
                    <option value="quarta">Quarta-feira</option>
                    <option value="quinta">Quinta-feira</option>
                    <option value="sexta">Sexta-feira</option>
                </select>
            </div>
            <div class="form-group hidden" id="grupoData">
                <label>Data Espec√≠fica <span style="color: #ef4444;">*</span></label>
                <input type="date" id="tarefaDataEspecifica">
                <span class="error-message hidden" id="tarefaDataError">Data √© obrigat√≥ria</span>
            </div>
            <div class="form-group">
                <label>Descri√ß√£o <span style="color: #ef4444;">*</span></label>
                <input type="text" id="tarefaDescricao" placeholder="Digite a descri√ß√£o da tarefa" required>
                <span class="error-message hidden" id="tarefaDescricaoError">Descri√ß√£o √© obrigat√≥ria</span>
            </div>
            <div class="form-group">
                <label>Hor√°rio <span style="color: #ef4444;">*</span></label>
                <input type="time" id="tarefaHorario" required>
                <span class="error-message hidden" id="tarefaHorarioError">Hor√°rio √© obrigat√≥rio</span>
            </div>
            <div class="form-group">
                <label>Recorr√™ncia</label>
                <select id="tarefaRecorrencia">
                    <option value="unica">√önica vez</option>
                    <option value="diaria">Di√°ria</option>
                    <option value="semanal">Semanal</option>
                    <option value="quinzenal">Quinzenal</option>
                    <option value="mensal">Mensal</option>
                </select>
            </div>
            <div class="form-group">
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="tarefaCalendario">
                        üìÖ Mostrar no calend√°rio da equipe
                    </label>
                </div>
                <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                    Marque para tarefas importantes que toda equipe deve ver
                </small>
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="fecharModal('modalTarefa')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarTarefa()" id="btnSalvarTarefa">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Editar Tarefa Individual -->
    <div id="modalEditarTarefa" class="modal">
        <div class="modal-content modal-editar-tarefa">
            <h3 style="margin-bottom: 24px;">‚úèÔ∏è Editar Tarefa</h3>
            <input type="hidden" id="editTarefaAtividadeId">
            <input type="hidden" id="editTarefaId">
            
            <div class="form-group">
                <label>Descri√ß√£o <span style="color: #ef4444;">*</span></label>
                <input type="text" id="editTarefaDescricao" placeholder="Digite a descri√ß√£o da tarefa" required>
                <span class="error-message hidden" id="editTarefaDescricaoError">Descri√ß√£o √© obrigat√≥ria</span>
            </div>
            
            <div class="form-group">
                <label>Prioridade</label>
                <select id="editTarefaPrioridade">
                    <option value="baixa">üü¢ Baixa</option>
                    <option value="media">üü° M√©dia</option>
                    <option value="alta">üî¥ Alta</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Respons√°vel</label>
                <select id="editTarefaResponsavel">
                    <!-- Ser√° preenchido dinamicamente -->
                </select>
            </div>
            
            <div class="form-group">
                <label>Prazo (opcional)</label>
                <input type="date" id="editTarefaPrazo">
            </div>
            
            <div class="form-group">
                <label>Depend√™ncias</label>
                <div id="editTarefaDependencias" style="max-height: 150px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 8px; padding: 12px;">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>
                <small style="color: #6b7280;">Selecione tarefas que devem ser conclu√≠das antes desta</small>
            </div>
            
            <div class="form-group">
                <label>Observa√ß√µes</label>
                <textarea id="editTarefaObservacoes" rows="3" placeholder="Adicione observa√ß√µes sobre a tarefa..."></textarea>
            </div>
            
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="fecharModal('modalEditarTarefa')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarEdicaoTarefa()">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Marcar Status (Aus√™ncia/Home Office) -->
    <div id="modalStatus" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 24px;">Marcar Status do Dia</h3>
            <div class="form-group">
                <label>Data <span style="color: #ef4444;">*</span></label>
                <input type="date" id="statusData" required>
                <span class="error-message hidden" id="statusDataError">Data √© obrigat√≥ria</span>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="statusTipo">
                    <option value="presente">‚úÖ Presente</option>
                    <option value="ausencia">‚ùå Aus√™ncia</option>
                    <option value="home-office">üè† Home Office</option>
                </select>
            </div>
            <div class="form-group">
                <label>Observa√ß√£o (opcional)</label>
                <input type="text" id="statusObservacao" placeholder="Ex: Consulta m√©dica, reuni√£o externa...">
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="fecharModal('modalStatus')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarStatus()">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Marcar Feriado -->
    <div id="modalFeriado" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 24px;">Gerenciar Feriados</h3>
            <div class="form-group">
                <label>Data <span style="color: #ef4444;">*</span></label>
                <input type="date" id="feriadoData" required>
                <span class="error-message hidden" id="feriadoDataError">Data √© obrigat√≥ria</span>
            </div>
            <div class="form-group">
                <label>Nome do Feriado <span style="color: #ef4444;">*</span></label>
                <input type="text" id="feriadoNome" placeholder="Ex: Dia da Independ√™ncia" required>
                <span class="error-message hidden" id="feriadoNomeError">Nome √© obrigat√≥rio</span>
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="fecharModal('modalFeriado')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarFeriado()">Salvar</button>
            </div>
            
            <hr style="margin: 24px 0;">
            
            <h4 style="margin-bottom: 16px;">Feriados Cadastrados</h4>
            <div id="listaFeriados"></div>
        </div>
    </div>
    
    <!-- Modal de Importar -->
    <div id="modalImportar" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 24px;">Importar Dados</h3>
            <div class="form-group">
                <label>Selecione o arquivo JSON</label>
                <input type="file" id="importFile" accept=".json">
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="fecharModal('modalImportar')">Cancelar</button>
                <button class="btn btn-primary" onclick="importarDados()">Importar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Sele√ß√£o de Tarefas -->
    <div id="modalSeletorTarefas" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h3 style="margin-bottom: 24px;">Vincular Tarefas ao Evento</h3>
            <div class="form-group">
                <label>Buscar tarefas</label>
                <input type="text" id="buscarTarefaVinculo" placeholder="Digite para buscar..." onkeyup="filtrarTarefasVinculo()">
            </div>
            <div style="max-height: 400px; overflow-y: auto; margin: 20px 0;">
                <div id="listaTarefasVinculo"></div>
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="fecharModalSeletorTarefas()">Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // ========== CONFIGURA√á√ÉO DO FIREBASE ==========
        // IMPORTANTE: Substitua com suas credenciais do Firebase
       const firebaseConfig = {
  apiKey: "AIzaSyCT0UXyU6AeurlaZdgM4_MKhzJWIdYxWg4",
  authDomain: "sistema-gestao-obra.firebaseapp.com",
  databaseURL: "https://sistema-gestao-obra-default-rtdb.firebaseio.com",
  projectId: "sistema-gestao-obra",
  storageBucket: "sistema-gestao-obra.firebasestorage.app",
  messagingSenderId: "686804029278",
  appId: "1:686804029278:web:758190822a19ef935e89cf",
  measurementId: "G-RE86WX5KY2"
};
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // ========== VARI√ÅVEIS GLOBAIS ==========
        let usuarioAtual = null;
        let listenersDados = {};
        let presenceRef = null;
        let connectedRef = null;
        let syncTimeout = null;
        let conflitosResolucao = null;
        let intervaloPrazos = null;
        
        // Constantes e configura√ß√µes
        const VERSAO_SISTEMA = '5.1';
        const VERSAO_DB = 5;
        const CHAVE_STORAGE = 'sistemaGestaoFirebase';
        const INTERVALO_SALVAMENTO = 5000;
        const INTERVALO_VERIFICACAO_PRAZOS = 3600000; // 1 hora
        
        // Estado Global do Sistema
        let estadoSistema = {
            mesAtual: 6,
            anoAtual: 2025,
            areaAtual: null,
            pessoaAtual: null,
            filtroAtual: 'todos',
            editandoAtividade: null,
            editandoEvento: null,
            editandoTarefa: null,
            pessoasSelecionadas: new Set(),
            tarefasVinculadas: new Map(),
            versaoSistema: VERSAO_SISTEMA,
            usuarioEmail: null,
            usuarioNome: null,
            alertasPrazosExibidos: new Set()
        };
        
        // Dados do Sistema
        let dados = null;
        
        // ========== FUN√á√ïES DE AUTENTICA√á√ÉO ==========
        function mostrarLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainContainer').classList.add('hidden');
            document.getElementById('usersOnline').classList.add('hidden');
        }
        
        function esconderLogin() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainContainer').classList.remove('hidden');
            document.getElementById('usersOnline').classList.remove('hidden');
        }
        
        function fazerLogin() {
            const email = document.getElementById('loginEmail').value;
            const senha = document.getElementById('loginPassword').value;
            
            if (!email || !senha) {
                mostrarNotificacao('Preencha todos os campos!', 'error');
                return;
            }
            
            mostrarNotificacao('Entrando...');
            
            auth.signInWithEmailAndPassword(email, senha)
                .then((userCredential) => {
                    usuarioAtual = userCredential.user;
                    inicializarSistema();
                })
                .catch((error) => {
                    console.error('Erro no login:', error);
                    if (error.code === 'auth/user-not-found') {
                        mostrarNotificacao('Usu√°rio n√£o encontrado!', 'error');
                    } else if (error.code === 'auth/wrong-password') {
                        mostrarNotificacao('Senha incorreta!', 'error');
                    } else {
                        mostrarNotificacao('Erro ao fazer login: ' + error.message, 'error');
                    }
                });
        }
        
        function mostrarRegistro() {
            const email = prompt('Digite seu email:');
            if (!email) return;
            
            const senha = prompt('Digite uma senha (m√≠nimo 6 caracteres):');
            if (!senha || senha.length < 6) {
                mostrarNotificacao('Senha deve ter no m√≠nimo 6 caracteres!', 'error');
                return;
            }
            
            const nome = prompt('Digite seu nome:');
            if (!nome) return;
            
            auth.createUserWithEmailAndPassword(email, senha)
                .then((userCredential) => {
                    return userCredential.user.updateProfile({
                        displayName: nome
                    });
                })
                .then(() => {
                    mostrarNotificacao('Conta criada com sucesso! Fazendo login...');
                    setTimeout(() => {
                        fazerLogin();
                    }, 1500);
                })
                .catch((error) => {
                    console.error('Erro ao criar conta:', error);
                    mostrarNotificacao('Erro ao criar conta: ' + error.message, 'error');
                });
        }
        
        function fazerLogout() {
            if (confirm('Deseja realmente sair?')) {
                if (presenceRef) {
                    presenceRef.remove();
                }
                
                Object.values(listenersDados).forEach(ref => {
                    if (ref && ref.off) {
                        ref.off();
                    }
                });

                if (intervaloPrazos) {
                    clearInterval(intervaloPrazos);
                }
                
                auth.signOut().then(() => {
                    mostrarNotificacao('At√© logo!');
                    mostrarLogin();
                }).catch((error) => {
                    console.error('Erro ao sair:', error);
                });
            }
        }
        
        // ========== SISTEMA DE PRESEN√áA ONLINE ==========
        function configurarPresenca() {
            const uid = usuarioAtual.uid;
            presenceRef = database.ref(`presence/${uid}`);
            connectedRef = database.ref('.info/connected');
            
            const userStatus = {
                uid: uid,
                email: usuarioAtual.email,
                nome: usuarioAtual.displayName || usuarioAtual.email.split('@')[0],
                online: true,
                ultimaAtividade: firebase.database.ServerValue.TIMESTAMP
            };
            
            connectedRef.on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    presenceRef.onDisconnect().remove();
                    presenceRef.set(userStatus);
                }
            });
            
            database.ref('presence').on('value', (snapshot) => {
                const usuarios = snapshot.val() || {};
                atualizarUsuariosOnline(usuarios);
            });
        }
        
        function atualizarUsuariosOnline(usuarios) {
            const lista = document.getElementById('usersOnlineList');
            lista.innerHTML = '';
            
            const usuariosArray = Object.values(usuarios).filter(u => u.online);
            
            usuariosArray.forEach(usuario => {
                const avatar = document.createElement('div');
                avatar.className = 'user-avatar online';
                avatar.textContent = usuario.nome ? usuario.nome.charAt(0).toUpperCase() : '?';
                
                const tooltip = document.createElement('div');
                tooltip.className = 'user-tooltip';
                tooltip.textContent = usuario.nome || usuario.email;
                
                avatar.appendChild(tooltip);
                lista.appendChild(avatar);
            });
            
            const contador = document.querySelector('.users-online > div:first-child');
            if (contador) {
                contador.textContent = `Equipe Online (${usuariosArray.length})`;
            }
        }
        
        // ========== SISTEMA DE SINCRONIZA√á√ÉO ==========
        function configurarSincronizacao() {
            listenersDados.dados = database.ref('dados').on('value', (snapshot) => {
                const dadosServidor = snapshot.val();
                
                if (dadosServidor) {
                    if (dados && dados.ultimaAtualizacao && 
                        dadosServidor.ultimaAtualizacao !== dados.ultimaAtualizacao &&
                        new Date(dadosServidor.ultimaAtualizacao) > new Date(dados.ultimaAtualizacao)) {
                        
                        if (temMudancasLocais()) {
                            mostrarConflito(dadosServidor);
                        } else {
                            dados = dadosServidor;
                            renderizarDashboard();
                            atualizarIndicadorSync('synced');
                        }
                    } else {
                        dados = dadosServidor;
                        renderizarDashboard();
                        atualizarIndicadorSync('synced');
                    }
                } else {
                    dados = inicializarDados();
                    salvarDados();
                }
            });
            
            listenersDados.atividades = database.ref('atividades').orderByChild('timestamp').limitToLast(50).on('child_added', (snapshot) => {
                const atividade = snapshot.val();
                if (atividade && atividade.usuario !== usuarioAtual.email) {
                    adicionarAtividadeLog(atividade);
                }
            });
            
            listenersDados.editando = database.ref('editando').on('value', (snapshot) => {
                const editando = snapshot.val() || {};
                atualizarIndicadoresEdicao(editando);
            });
        }
        
        function atualizarIndicadorSync(status) {
            const indicator = document.getElementById('syncIndicator');
            const loader = document.getElementById('syncLoader');
            const text = document.getElementById('syncText');
            
            indicator.className = 'sync-indicator';
            
            switch(status) {
                case 'syncing':
                    indicator.classList.add('syncing');
                    loader.style.display = 'inline-block';
                    text.textContent = 'Sincronizando...';
                    break;
                case 'synced':
                    indicator.classList.add('synced');
                    loader.style.display = 'none';
                    text.textContent = '‚úì Sincronizado';
                    break;
                case 'error':
                    indicator.classList.add('error');
                    loader.style.display = 'none';
                    text.textContent = '‚úó Erro de sincroniza√ß√£o';
                    break;
                case 'offline':
                    indicator.classList.add('offline');
                    loader.style.display = 'none';
                    text.textContent = '‚óâ Offline';
                    break;
            }
        }
        
        // ========== FUN√á√ïES DE SALVAMENTO FIREBASE ==========
        function salvarDados() {
            if (!usuarioAtual) return;
            
            try {
                atualizarIndicadorSync('syncing');
                
                dados.ultimaAtualizacao = new Date().toISOString();
                dados.ultimoUsuario = usuarioAtual.email;
                
                database.ref('dados').set(dados).then(() => {
                    console.log('Dados salvos no Firebase');
                    atualizarIndicadorSync('synced');
                    
                    registrarAtividade('dados_salvos', {
                        usuario: usuarioAtual.email,
                        timestamp: dados.ultimaAtualizacao
                    });
                }).catch((error) => {
                    console.error('Erro ao salvar:', error);
                    atualizarIndicadorSync('error');
                    mostrarNotificacao('Erro ao salvar dados!', 'error');
                });
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
                atualizarIndicadorSync('error');
                mostrarNotificacao('Erro ao salvar dados!', 'error');
            }
        }
        
        function registrarAtividade(tipo, detalhes) {
            const atividade = {
                tipo: tipo,
                usuario: usuarioAtual.email,
                nomeUsuario: usuarioAtual.displayName || usuarioAtual.email.split('@')[0],
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                detalhes: detalhes
            };
            
            database.ref('atividades').push(atividade);
        }
        
        function marcarEditando(tipo, id) {
            if (!usuarioAtual) return;
            
            const ref = database.ref(`editando/${tipo}_${id}`);
            ref.set({
                usuario: usuarioAtual.email,
                nomeUsuario: usuarioAtual.displayName || usuarioAtual.email.split('@')[0],
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            setTimeout(() => {
                ref.remove();
            }, 30000);
        }
        
        function pararEditando(tipo, id) {
            if (!usuarioAtual) return;
            database.ref(`editando/${tipo}_${id}`).remove();
        }
        
        // ========== LOG DE ATIVIDADES ==========
        function toggleActivityLog() {
            const log = document.getElementById('activityLog');
            log.classList.toggle('active');
        }
        
        function adicionarAtividadeLog(atividade) {
            const container = document.getElementById('activityLogContent');
            const item = document.createElement('div');
            item.className = 'activity-item';
            
            const tempo = new Date(atividade.timestamp).toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let mensagem = '';
            switch(atividade.tipo) {
                case 'atividade_criada':
                    mensagem = `${atividade.nomeUsuario} criou "${atividade.detalhes.nome}"`;
                    break;
                case 'status_alterado':
                    mensagem = `${atividade.nomeUsuario} alterou status de "${atividade.detalhes.atividade}"`;
                    break;
                case 'evento_criado':
                    mensagem = `${atividade.nomeUsuario} criou evento "${atividade.detalhes.titulo}"`;
                    break;
                case 'tarefa_editada':
                    mensagem = `${atividade.nomeUsuario} editou tarefa "${atividade.detalhes.tarefa}"`;
                    break;
                default:
                    mensagem = `${atividade.nomeUsuario} fez uma altera√ß√£o`;
            }
            
            item.innerHTML = `
                <div>${mensagem}</div>
                <div class="time">${tempo}</div>
            `;
            
            container.insertBefore(item, container.firstChild);
            
            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }
        
        // ========== TRATAMENTO DE CONFLITOS ==========
        function temMudancasLocais() {
            return false;
        }
        
        function mostrarConflito(dadosServidor) {
            conflitosResolucao = dadosServidor;
            document.getElementById('conflictMessage').textContent = 
                `${dadosServidor.ultimoUsuario} fez altera√ß√µes. O que deseja fazer?`;
            document.getElementById('conflictModal').classList.add('active');
        }
        
        function resolverConflito(acao) {
            document.getElementById('conflictModal').classList.remove('active');
            
            if (acao === 'descartar' && conflitosResolucao) {
                dados = conflitosResolucao;
                renderizarDashboard();
                mostrarNotificacao('Usando vers√£o do servidor');
            } else {
                salvarDados();
                mostrarNotificacao('Mantendo suas altera√ß√µes');
            }
            
            conflitosResolucao = null;
        }
        
        // ========== INDICADORES DE EDI√á√ÉO ==========
        function atualizarIndicadoresEdicao(editando) {
            document.querySelectorAll('.editing-indicator').forEach(el => el.remove());
            
            Object.entries(editando).forEach(([key, info]) => {
                if (info.usuario !== usuarioAtual.email) {
                    const [tipo, id] = key.split('_');
                    
                    if (tipo === 'atividade') {
                        const elemento = document.querySelector(`[data-atividade-id="${id}"]`);
                        if (elemento && !elemento.querySelector('.editing-indicator')) {
                            const indicator = document.createElement('span');
                            indicator.className = 'editing-indicator';
                            indicator.textContent = `${info.nomeUsuario} editando...`;
                            elemento.appendChild(indicator);
                        }
                    }
                }
            });
        }

        // ========== SISTEMA DE VERIFICA√á√ÉO AUTOM√ÅTICA DE PRAZOS ==========
        function iniciarVerificacaoPrazos() {
            // Verifica√ß√£o inicial
            verificarPrazosAtividades();
            
            // Verifica√ß√£o a cada hora
            intervaloPrazos = setInterval(() => {
                verificarPrazosAtividades();
            }, INTERVALO_VERIFICACAO_PRAZOS);
        }

        function verificarPrazosAtividades() {
            if (!dados || !dados.areas) return;

            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            Object.values(dados.areas).forEach(area => {
                area.atividades.forEach(atividade => {
                    const prazoData = new Date(atividade.prazo);
                    prazoData.setHours(0, 0, 0, 0);
                    
                    const diasRestantes = Math.floor((prazoData - hoje) / (1000 * 60 * 60 * 24));
                    const statusAnterior = atividade.status;
                    let novoStatus = statusAnterior;

                    // L√≥gica de atualiza√ß√£o autom√°tica de status
                    if (diasRestantes < 0 && atividade.status !== 'vermelho') {
                        novoStatus = 'vermelho'; // Atrasado
                    } else if (diasRestantes <= 3 && diasRestantes >= 0 && atividade.status === 'verde') {
                        novoStatus = 'amarelo'; // Aten√ß√£o - perto do prazo
                    }

                    // Atualizar status se necess√°rio
                    if (novoStatus !== statusAnterior) {
                        atividade.status = novoStatus;
                        
                        registrarAtividade('status_automatico', {
                            atividade: atividade.nome,
                            de: statusAnterior,
                            para: novoStatus,
                            motivo: diasRestantes < 0 ? 'prazo_vencido' : 'prazo_proximo'
                        });

                        console.log(`Status da atividade "${atividade.nome}" alterado automaticamente de ${statusAnterior} para ${novoStatus}`);
                    }

                    // Alertas de prazo
                    const alertaKey = `${atividade.id}_${atividade.prazo}`;
                    if (!estadoSistema.alertasPrazosExibidos.has(alertaKey)) {
                        if (diasRestantes === 0) {
                            mostrarAlertaPrazo(`‚è∞ PRAZO HOJE: ${atividade.nome}`, 'error');
                            estadoSistema.alertasPrazosExibidos.add(alertaKey);
                        } else if (diasRestantes === 1) {
                            mostrarAlertaPrazo(`‚ö†Ô∏è Prazo amanh√£: ${atividade.nome}`, 'warning');
                            estadoSistema.alertasPrazosExibidos.add(alertaKey);
                        } else if (diasRestantes === 3) {
                            mostrarAlertaPrazo(`üìÖ Prazo em 3 dias: ${atividade.nome}`, 'warning');
                            estadoSistema.alertasPrazosExibidos.add(alertaKey);
                        } else if (diasRestantes === -1) {
                            mostrarAlertaPrazo(`üö® ATRASADO: ${atividade.nome}`, 'error');
                            estadoSistema.alertasPrazosExibidos.add(alertaKey);
                        }
                    }
                });
            });

            // Salvar se houve mudan√ßas
            salvarDados();
        }

        function mostrarAlertaPrazo(mensagem, tipo = 'warning') {
            const alertaExistente = document.querySelector('.alerta-prazo');
            if (alertaExistente) {
                alertaExistente.remove();
            }

            const alerta = document.createElement('div');
            alerta.className = `alerta-prazo ${tipo}`;
            alerta.innerHTML = `
                ${mensagem}
                <span class="close-btn" onclick="this.parentElement.remove()">√ó</span>
            `;

            document.body.appendChild(alerta);

            // Auto-remover ap√≥s 10 segundos
            setTimeout(() => {
                if (alerta.parentElement) {
                    alerta.remove();
                }
            }, 10000);
        }

        // ========== VALIDA√á√ÉO DE PRAZOS ==========
        function validarPrazoAtividade() {
            const prazoInput = document.getElementById('atividadePrazo');
            const hoje = new Date().toISOString().split('T')[0];
            
            if (prazoInput.value && prazoInput.value < hoje) {
                prazoInput.classList.add('prazo-invalido');
                document.getElementById('atividadePrazoPassadoError').classList.remove('hidden');
                mostrarNotificacao('N√£o √© poss√≠vel criar atividade com prazo no passado!', 'error');
                return false;
            } else {
                prazoInput.classList.remove('prazo-invalido');
                document.getElementById('atividadePrazoPassadoError').classList.add('hidden');
                return true;
            }
        }
        
        // ========== INICIALIZA√á√ÉO DO SISTEMA ==========
        // ========== INICIALIZA√á√ÉO MELHORADA DO SISTEMA ==========
        function inicializarSistema() {
            console.log('üöÄ Iniciando Sistema de Gest√£o v5.1...');
            
            esconderLogin();
            
            estadoSistema.usuarioEmail = usuarioAtual.email;
            estadoSistema.usuarioNome = usuarioAtual.displayName || usuarioAtual.email.split('@')[0];
            
            document.getElementById('usuarioInfo').textContent = `üë§ ${estadoSistema.usuarioNome}`;
            
            // Configura√ß√µes em sequ√™ncia
            try {
                configurarPresenca();
                console.log('‚úÖ Presen√ßa online configurada');
                
                configurarSincronizacao();
                console.log('‚úÖ Sincroniza√ß√£o Firebase configurada');
                
                iniciarVerificacaoPrazos();
                console.log('‚úÖ Verifica√ß√£o autom√°tica de prazos iniciada');
                
                // Otimiza√ß√£o ap√≥s 5 segundos
                setTimeout(otimizarDesempenho, 5000);
                
                mostrarNotificacao(`‚ú® Bem-vindo(a), ${estadoSistema.usuarioNome}! Sistema v5.1 pronto!`);
                
                console.log('üéâ Sistema totalmente inicializado com sucesso!');
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                mostrarNotificacao('Erro na inicializa√ß√£o do sistema', 'error');
            }
        }
        
        // ========== MONITORAR ESTADO DE AUTENTICA√á√ÉO ==========
        auth.onAuthStateChanged((user) => {
            if (user) {
                usuarioAtual = user;
                inicializarSistema();
            } else {
                mostrarLogin();
            }
        });
        
        // ========== DETECTOR DE CONEX√ÉO ==========
        window.addEventListener('online', () => {
            atualizarIndicadorSync('syncing');
            mostrarNotificacao('Conex√£o restaurada!');
        });
        
        window.addEventListener('offline', () => {
            atualizarIndicadorSync('offline');
            mostrarNotificacao('Sem conex√£o - trabalhando offline', 'error');
        });
        
        // ========== TODAS AS FUN√á√ïES DO SISTEMA ORIGINAL ==========
        
        // Fun√ß√£o para inicializar dados padr√£o
        function inicializarDados() {
            return {
                versao: VERSAO_DB,
                areas: {
                    documentacao: {
                        nome: "Documenta√ß√£o & Arquivo",
                        coordenador: "Renato Remiro",
                        cor: "#8b5cf6",
                        equipe: [
                            {nome: "Renato", cargo: "Coordenador"},
                            {nome: "Bruna", cargo: "Arquiteta Trainee"},
                            {nome: "Juliana A.", cargo: "Estagi√°ria de Arquitetura"},
                            {nome: "Lara", cargo: "Arquiteta Trainee"}
                        ],
                        atividades: [
                            {id: 1, nome: "As Built", status: "verde", prazo: "2025-07-18", responsaveis: ["Renato", "Bruna"], progresso: 0, dataAdicionado: new Date().toISOString()},
                            {id: 2, nome: "Relat√≥rio Fotogr√°fico", status: "amarelo", prazo: "2025-07-12", responsaveis: ["Bruna"], progresso: 0, dataAdicionado: new Date().toISOString()},
                            {id: 3, nome: "Manual de Conserva√ß√£o", status: "verde", prazo: "2025-07-25", responsaveis: ["Renato"], progresso: 0, dataAdicionado: new Date().toISOString()},
                            {id: 4, nome: "BIM 2D", status: "verde", prazo: "2025-07-20", responsaveis: ["Bruna"], progresso: 0, dataAdicionado: new Date().toISOString()},
                            {id: 5, nome: "BIM", status: "verde", prazo: "2025-07-22", responsaveis: ["Bruna"], progresso: 0, dataAdicionado: new Date().toISOString()},
                            {id: 6, nome: "Databook", status: "verde", prazo: "2025-07-18", responsaveis: ["Juliana A."], progresso: 0, dataAdicionado: new Date().toISOString()}
                        ]
                    },
                    planejamento: {
                        nome: "Planejamento & Controle de Obra",
                        coordenador: "Isabella Rocha (Coord. Geral)",
                        cor: "#06b6d4",
                        equipe: [
                            {nome: "Isabella", cargo: "Coordenadora Geral"},
                            {nome: "Lara", cargo: "Arquiteta Trainee"},
                            {nome: "Eduardo", cargo: "Engenheiro Civil"},
                            {nome: "Beto", cargo: "Assistente de Campo"},
                            {nome: "Jean", cargo: "Estagi√°rio de Eng. Civil"}
                        ],
                        atividades: [
                            {id: 7, nome: "Cronograma Longo Prazo (CLP)", status: "verde", prazo: "2025-07-10", responsaveis: ["Lara", "Isabella"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 8, nome: "PPCO", status: "verde", prazo: "2025-07-31", responsaveis: ["Lara", "Isabella"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 9, nome: "V√≠nculos Or√ßament√°rios", status: "verde", prazo: "2025-07-31", responsaveis: ["Lara", "Isabella"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 10, nome: "CFF", status: "amarelo", prazo: "2025-07-15", responsaveis: ["Isabella"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 11, nome: "Previs√£o Financeira", status: "verde", prazo: "2025-07-31", responsaveis: ["Eduardo", "Isabella"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 12, nome: "Planilha de Medi√ß√£o", status: "amarelo", prazo: "2025-07-12", responsaveis: ["Lara", "Isabella"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 13, nome: "CCP", status: "verde", prazo: "2025-07-05", responsaveis: ["Lara", "Beto", "Eduardo"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []}
                        ]
                    },
                    producao: {
                        nome: "Produ√ß√£o & Qualidade",
                        coordenador: "Beto / Eduardo",
                        cor: "#ef4444",
                        equipe: [
                            {nome: "Beto", cargo: "Arquiteto"},
                            {nome: "Eduardo", cargo: "Coordenador Eng. Civil"},
                            {nome: "Jean", cargo: "Estagi√°rio de Eng. Civil"},
                            {nome: "Nominato", cargo: "Almoxarifado"},
                            {nome: "Alex", cargo: "Comprador"},
                            {nome: "Manu", cargo: "Assistente de Arquitetura"},
                            {nome: "Marcus", cargo: "Especialista Meio Ambiente"},
                            {nome: "Juliana E.", cargo: "T√©cnica de Enfermagem"},
                            {nome: "Carlos", cargo: "T√©cnico de Seguran√ßa"}
                        ],
                        atividades: [
                            {id: 14, nome: "Levantamento de Materiais", status: "verde", prazo: "2025-07-05", responsaveis: ["Jean", "Beto", "Eduardo"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 15, nome: "Certifica√ß√£o de Estoque", status: "verde", prazo: "2025-07-31", responsaveis: ["Nominato", "Jean", "Eduardo"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 16, nome: "Controle de Patrim√¥nio", status: "verde", prazo: "2025-07-31", responsaveis: ["Nominato", "Alex"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 17, nome: "Procedimento SIENGE", status: "amarelo", prazo: "2025-07-09", responsaveis: ["Alex", "Eduardo"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 18, nome: "Lan√ßamento de Solicita√ß√µes", status: "verde", prazo: "2025-07-01", responsaveis: ["Nominato", "Alex", "Eduardo"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 19, nome: "Negocia√ß√µes de Compra", status: "amarelo", prazo: "2025-07-05", responsaveis: ["Alex", "Eduardo"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []}
                        ]
                    }
                },
                eventos: [
                    {
                        id: 1, 
                        titulo: "Reuni√£o semanal de planejamento", 
                        tipo: "reuniao",
                        data: "2025-07-01",
                        horarioInicio: "09:00",
                        horarioFim: "11:00",
                        diaCompleto: false,
                        pessoas: ["Isabella", "Lara", "Eduardo", "Beto"],
                        local: "Sala de reuni√£o principal",
                        descricao: "Revis√£o do cronograma e distribui√ß√£o de tarefas da semana",
                        recorrencia: {
                            tipo: "semanal",
                            diasSemana: [1],
                            fim: null
                        }
                    },
                    {
                        id: 2, 
                        titulo: "Entrega Relat√≥rio Fotogr√°fico", 
                        tipo: "entrega",
                        data: "2025-07-15",
                        horarioInicio: "17:00",
                        diaCompleto: false,
                        pessoas: ["Bruna"],
                        descricao: "Entrega mensal do relat√≥rio com registro fotogr√°fico do progresso da obra"
                    },
                    {
                        id: 3, 
                        titulo: "Microprograma√ß√£o R00", 
                        tipo: "prazo",
                        data: "2025-07-08",
                        horarioInicio: "23:59",
                        diaCompleto: false,
                        pessoas: ["Lara"],
                        tarefasRelacionadas: [{atividadeId: 7, tipo: "entrega"}]
                    }
                ],
                agendas: {},
                feriados: {},
                statusPessoal: {},
                historico: [],
                ultimaAtualizacao: new Date().toISOString()
            };
        }
        
        // Fun√ß√µes de Utilidade
        function mostrarNotificacao(texto, tipo = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            notificationText.textContent = texto;
            notification.className = `notification ${tipo === 'error' ? 'error' : tipo === 'warning' ? 'warning' : ''}`;
            notification.classList.add('active');
            setTimeout(() => {
                notification.classList.remove('active');
            }, 3000);
        }
        
        function formatarData(data) {
            const d = new Date(data);
            return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}`;
        }
        
        function calcularDiasRestantes(prazo) {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const dataPrazo = new Date(prazo);
            dataPrazo.setHours(0, 0, 0, 0);
            return Math.floor((dataPrazo - hoje) / (1000 * 60 * 60 * 24));
        }
        
        // Fun√ß√µes de Calend√°rio
        function gerarCalendario() {
            const calendario = document.getElementById('calendario');
            calendario.innerHTML = '';
            
            const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            diasSemana.forEach(dia => {
                const header = document.createElement('div');
                header.className = 'dia-header';
                header.textContent = dia;
                calendario.appendChild(header);
            });
            
            const primeiroDia = new Date(estadoSistema.anoAtual, estadoSistema.mesAtual, 1);
            const ultimoDia = new Date(estadoSistema.anoAtual, estadoSistema.mesAtual + 1, 0);
            const primeiroDiaSemana = primeiroDia.getDay();
            
            for (let i = 0; i < primeiroDiaSemana; i++) {
                const diaVazio = document.createElement('div');
                diaVazio.className = 'dia';
                diaVazio.style.background = '#f9fafb';
                calendario.appendChild(diaVazio);
            }
            
            for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
                const diaDiv = document.createElement('div');
                diaDiv.className = 'dia';
                
                const dataCompleta = `${estadoSistema.anoAtual}-${String(estadoSistema.mesAtual + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                
                if (dados.feriados && dados.feriados[dataCompleta]) {
                    diaDiv.classList.add('dia-feriado');
                }
                
                const numeroDiv = document.createElement('div');
                numeroDiv.className = 'dia-numero';
                numeroDiv.innerHTML = `<span>${dia}</span>`;
                
                if (dados.feriados && dados.feriados[dataCompleta]) {
                    numeroDiv.innerHTML += `<span class="feriado-label" title="${dados.feriados[dataCompleta]}">Feriado</span>`;
                }
                
                diaDiv.appendChild(numeroDiv);
                
                const eventosDia = obterEventosDoDia(dataCompleta);
                
                eventosDia.sort((a, b) => {
                    const horaA = a.diaCompleto ? '00:00' : a.horarioInicio;
                    const horaB = b.diaCompleto ? '00:00' : b.horarioInicio;
                    return horaA.localeCompare(horaB);
                });
                
                eventosDia.forEach(evento => {
                    const eventoDiv = document.createElement('div');
                    eventoDiv.className = `evento evento-${evento.tipo}`;
                    
                    if (evento.diaCompleto) {
                        eventoDiv.classList.add('evento-dia-completo');
                    }
                    
                    if (evento.dataFim && evento.data !== evento.dataFim) {
                        eventoDiv.classList.add('evento-multi-dia');
                    }
                    
                    let iconeTipo = '';
                    switch(evento.tipo) {
                        case 'reuniao': iconeTipo = 'üìÖ'; break;
                        case 'entrega': iconeTipo = 'üì¶'; break;
                        case 'prazo': iconeTipo = '‚è∞'; break;
                        case 'marco': iconeTipo = 'üéØ'; break;
                        case 'outro': iconeTipo = 'üìå'; break;
                    }
                    
                    let htmlEvento = `
                        <div class="evento-header">
                            <span>${iconeTipo} ${evento.diaCompleto ? 'Dia todo' : evento.horarioInicio}</span>
                            ${evento.recorrencia ? '<span class="recorrente-indicator">üîÑ</span>' : ''}
                        </div>
                        <div style="font-weight: 500;">${evento.titulo}</div>
                    `;
                    
                    if (evento.pessoas && evento.pessoas.length > 0) {
                        const labelPessoas = evento.tipo === 'reuniao' ? 'üë•' : 'üë§';
                        htmlEvento += `<div class="evento-info">${labelPessoas} ${evento.pessoas.length} ${evento.pessoas.length > 1 ? 'pessoas' : 'pessoa'}</div>`;
                    }
                    
                    if (evento.local) {
                        htmlEvento += `<div class="evento-info">üìç ${evento.local}</div>`;
                    }
                    
                    if (evento.tarefasRelacionadas && evento.tarefasRelacionadas.length > 0) {
                        htmlEvento += `<div class="evento-info">üìã ${evento.tarefasRelacionadas.length} tarefa(s)</div>`;
                    }
                    
                    if (evento.horarioFim && !evento.diaCompleto) {
                        htmlEvento += `<div class="evento-duracao">at√© ${evento.horarioFim}</div>`;
                    }
                    
                    eventoDiv.innerHTML = htmlEvento;
                    
                    eventoDiv.onclick = function(e) {
                        e.stopPropagation();
                        editarEvento(evento);
                    };
                    
                    eventoDiv.title = `${evento.titulo}\n${evento.descricao || 'Clique para editar'}`;
                    
                    const deleteBtn = document.createElement('span');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.innerHTML = '√ó';
                    deleteBtn.onclick = function(e) {
                        e.stopPropagation();
                        deletarEvento(evento.id);
                    };
                    eventoDiv.appendChild(deleteBtn);
                    
                    diaDiv.appendChild(eventoDiv);
                });
                
                diaDiv.onclick = (e) => {
                    if (e.target === diaDiv || e.target.classList.contains('dia-numero')) {
                        document.getElementById('eventoData').value = dataCompleta;
                        mostrarNovoEvento();
                    }
                };
                
                calendario.appendChild(diaDiv);
            }
            
            const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            document.getElementById('mesAno').textContent = `${meses[estadoSistema.mesAtual]} ${estadoSistema.anoAtual}`;
            
            atualizarTimeline();
        }
        
        function obterEventosDoDia(data) {
            if (!dados || !dados.eventos) return [];
            
            const dataObj = new Date(data + 'T00:00:00');
            const diaSemana = dataObj.getDay();
            const eventos = [];
            
            dados.eventos.forEach(evento => {
                if (evento.data === data) {
                    eventos.push(evento);
                }
                else if (evento.dataFim) {
                    const inicio = new Date(evento.data + 'T00:00:00');
                    const fim = new Date(evento.dataFim + 'T00:00:00');
                    const atual = new Date(data + 'T00:00:00');
                    if (atual >= inicio && atual <= fim) {
                        eventos.push({...evento, continuacao: true});
                    }
                }
                else if (evento.recorrencia) {
                    if (verificarRecorrencia(evento, data)) {
                        eventos.push({...evento, recorrente: true});
                    }
                }
            });
            
            return eventos;
        }
        
        function verificarRecorrencia(evento, data) {
            const dataEvento = new Date(evento.data + 'T00:00:00');
            const dataVerificar = new Date(data + 'T00:00:00');
            
            if (dataVerificar < dataEvento) return false;
            
            if (evento.recorrencia.fim) {
                const fimRecorrencia = new Date(evento.recorrencia.fim + 'T00:00:00');
                if (dataVerificar > fimRecorrencia) return false;
            }
            
            const tipo = evento.recorrencia.tipo;
            
            switch(tipo) {
                case 'diaria':
                    return true;
                    
                case 'semanal':
                    const diaSemana = dataVerificar.getDay();
                    return evento.recorrencia.diasSemana && evento.recorrencia.diasSemana.includes(diaSemana);
                    
                case 'quinzenal':
                    const diffDias = Math.floor((dataVerificar - dataEvento) / (1000 * 60 * 60 * 24));
                    return diffDias % 14 === 0 && dataVerificar.getDay() === dataEvento.getDay();
                    
                case 'mensal':
                    return dataEvento.getDate() === dataVerificar.getDate();
                    
                case 'bimestral':
                    const mesesDiff = (dataVerificar.getFullYear() - dataEvento.getFullYear()) * 12 + 
                                      (dataVerificar.getMonth() - dataEvento.getMonth());
                    return mesesDiff % 2 === 0 && dataEvento.getDate() === dataVerificar.getDate();
                    
                default:
                    return false;
            }
        }
        
        function atualizarTimeline() {
            const timeline = document.getElementById('timelineEventos');
            if (!timeline || !dados) return;
            
            timeline.innerHTML = '';
            
            const hoje = new Date();
            const eventos = [];
            
            for (let i = 0; i < 7; i++) {
                const data = new Date(hoje);
                data.setDate(hoje.getDate() + i);
                const dataStr = data.toISOString().split('T')[0];
                
                const eventosDia = obterEventosDoDia(dataStr);
                eventosDia.forEach(evento => {
                    eventos.push({
                        ...evento,
                        dataCompleta: dataStr,
                        diasRestantes: i
                    });
                });
            }
            
            eventos.sort((a, b) => {
                if (a.dataCompleta !== b.dataCompleta) {
                    return a.dataCompleta.localeCompare(b.dataCompleta);
                }
                return (a.horarioInicio || '00:00').localeCompare(b.horarioInicio || '00:00');
            });
            
            eventos.slice(0, 5).forEach(evento => {
                const item = document.createElement('div');
                item.className = 'timeline-item';
                
                let tipoTexto = '';
                let corMarker = '';
                switch(evento.tipo) {
                    case 'reuniao': tipoTexto = 'Reuni√£o'; corMarker = '#3b82f6'; break;
                    case 'entrega': tipoTexto = 'Entrega'; corMarker = '#10b981'; break;
                    case 'prazo': tipoTexto = 'Prazo'; corMarker = '#ef4444'; break;
                    case 'marco': tipoTexto = 'Marco'; corMarker = '#8b5cf6'; break;
                    case 'outro': tipoTexto = 'Evento'; corMarker = '#6b7280'; break;
                }
                
                item.innerHTML = `
                    <div class="timeline-marker" style="border-color: ${corMarker};"></div>
                    <div class="timeline-content">
                        <div style="font-weight: 600; margin-bottom: 4px;">${evento.titulo}</div>
                        <div style="font-size: 13px; color: #6b7280;">
                            ${evento.diasRestantes === 0 ? 'Hoje' : evento.diasRestantes === 1 ? 'Amanh√£' : `Em ${evento.diasRestantes} dias`}
                            ‚Ä¢ ${formatarData(evento.dataCompleta)}
                            ${evento.diaCompleto ? '‚Ä¢ Dia todo' : `‚Ä¢ ${evento.horarioInicio}`}
                        </div>
                        ${evento.pessoas && evento.pessoas.length > 0 ? 
                            `<div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                ${evento.tipo === 'reuniao' ? 'Participantes' : 'Respons√°veis'}: ${evento.pessoas.join(', ')}
                            </div>` : ''}
                    </div>
                `;
                
                timeline.appendChild(item);
            });
            
            if (eventos.length === 0) {
                timeline.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">Nenhum evento nos pr√≥ximos 7 dias</div>';
            }
        }
        
        function mudarMes(direcao) {
            estadoSistema.mesAtual += direcao;
            if (estadoSistema.mesAtual < 0) {
                estadoSistema.mesAtual = 11;
                estadoSistema.anoAtual--;
            } else if (estadoSistema.mesAtual > 11) {
                estadoSistema.mesAtual = 0;
                estadoSistema.anoAtual++;
            }
            gerarCalendario();
            atualizarEstatisticas();
        }
        
        // Fun√ß√µes de Dashboard
        
        // ========== SISTEMA DE VERIFICA√á√ÉO E OTIMIZA√á√ÉO ==========
        function verificarIntegridadeSistema() {
            console.log('üîç Verificando integridade do sistema...');
            
            const verificacoes = {
                dados: !!dados,
                areas: dados && Object.keys(dados.areas).length > 0,
                eventos: dados && Array.isArray(dados.eventos),
                firebase: !!firebase && !!database,
                usuario: !!usuarioAtual,
                automacoes: !!intervaloPrazos
            };
            
            console.log('‚úÖ Status das verifica√ß√µes:', verificacoes);
            
            const problemasEncontrados = Object.entries(verificacoes)
                .filter(([chave, valor]) => !valor)
                .map(([chave]) => chave);
            
            if (problemasEncontrados.length > 0) {
                console.warn('‚ö†Ô∏è Problemas encontrados:', problemasEncontrados);
                mostrarNotificacao(`Problemas detectados: ${problemasEncontrados.join(', ')}`, 'warning');
            } else {
                console.log('‚úÖ Sistema √≠ntegro e funcionando corretamente!');
            }
            
            return verificacoes;
        }

        function otimizarDesempenho() {
            // Remove listeners duplicados se existirem
            if (intervaloPrazos) {
                clearInterval(intervaloPrazos);
            }
            
            // Reinicia verifica√ß√£o de prazos
            iniciarVerificacaoPrazos();
            
            // Limpa cache de alertas antigos (mais de 24h)
            const agora = new Date();
            estadoSistema.alertasPrazosExibidos.forEach(alertaKey => {
                const [id, prazo] = alertaKey.split('_');
                const prazoDat = new Date(prazo);
                if (agora - prazoDat > 24 * 60 * 60 * 1000) {
                    estadoSistema.alertasPrazosExibidos.delete(alertaKey);
                }
            });
            
            console.log('üöÄ Sistema otimizado com sucesso!');
        }

        // ========== FUN√á√ïES DE INTEGRA√á√ÉO MELHORADA ==========
        function renderizarDashboard() {
            if (!dados) return;
            
            renderizarAreas();
            gerarCalendario();
            atualizarEstatisticas();
            atualizarDataAtual();
            preencherSelectResponsaveis();
            
            // ‚úÖ VERIFICA√á√ÉO AUTOM√ÅTICA DE INTEGRIDADE
            setTimeout(verificarIntegridadeSistema, 1000);
        }
        
        function renderizarAreas() {
            const grid = document.getElementById('areasGrid');
            if (!grid || !dados) return;
            
            grid.innerHTML = '';
            
            Object.entries(dados.areas).forEach(([key, area]) => {
                const statusCount = contarStatus(area.atividades);
                const card = document.createElement('div');
                card.className = 'card area-card';
                card.onclick = () => mostrarArea(key);
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>${area.nome}</h3>
                        <div style="width: 20px; height: 20px; background: ${area.cor}; border-radius: 50%;"></div>
                    </div>
                    <p style="color: #6b7280; margin-bottom: 16px;">Coord: ${area.coordenador}</p>
                    <div style="margin-bottom: 16px;">
                        <div style="margin-bottom: 8px;">
                            <span class="status-indicator status-verde"></span>Em dia: ${statusCount.verde}
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span class="status-indicator status-amarelo"></span>Aten√ß√£o: ${statusCount.amarelo}
                        </div>
                        <div>
                            <span class="status-indicator status-vermelho"></span>Atraso: ${statusCount.vermelho}
                        </div>
                    </div>
                    <p style="color: #3b82f6; font-weight: 500;">Ver detalhes ‚Üí</p>
                `;
                
                grid.appendChild(card);
            });
        }
        
        function contarStatus(atividades) {
            return atividades.reduce((acc, ativ) => {
                acc[ativ.status]++;
                return acc;
            }, {verde: 0, amarelo: 0, vermelho: 0});
        }
        
        function atualizarEstatisticas() {
            if (!dados) return;
            
            let totalVerde = 0, totalAmarelo = 0, totalVermelho = 0;
            
            Object.values(dados.areas).forEach(area => {
                const count = contarStatus(area.atividades);
                totalVerde += count.verde;
                totalAmarelo += count.amarelo;
                totalVermelho += count.vermelho;
            });
            
            const total = totalVerde + totalAmarelo + totalVermelho;
            
            document.getElementById('statEmDia').textContent = totalVerde;
            document.getElementById('statAtencao').textContent = totalAmarelo;
            document.getElementById('statAtraso').textContent = totalVermelho;
            
            if (total > 0) {
                document.getElementById('progressEmDia').style.width = `${(totalVerde / total) * 100}%`;
                document.getElementById('progressAtencao').style.width = `${(totalAmarelo / total) * 100}%`;
                document.getElementById('progressAtraso').style.width = `${(totalVermelho / total) * 100}%`;
            }
            
            const eventosDoMes = [];
            const primeiroDia = new Date(estadoSistema.anoAtual, estadoSistema.mesAtual, 1);
            const ultimoDia = new Date(estadoSistema.anoAtual, estadoSistema.mesAtual + 1, 0);
            
            for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
                const data = `${estadoSistema.anoAtual}-${String(estadoSistema.mesAtual + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                const eventosDia = obterEventosDoDia(data);
                eventosDoMes.push(...eventosDia);
            }
            
            const eventosUnicos = new Map();
            eventosDoMes.forEach(evento => {
                const key = `${evento.id}_${evento.titulo}`;
                if (!eventosUnicos.has(key)) {
                    eventosUnicos.set(key, evento);
                }
            });
            
            document.getElementById('statEventos').textContent = eventosUnicos.size;
        }
        
        function atualizarDataAtual() {
            const hoje = new Date();
            const opcoes = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dataAtual').textContent = hoje.toLocaleDateString('pt-BR', opcoes);
        }
        
        // Fun√ß√µes de Navega√ß√£o
        function mostrarArea(areaKey) {
            estadoSistema.areaAtual = areaKey;
            const area = dados.areas[areaKey];
            
            document.getElementById('dashboardExecutivo').classList.add('hidden');
            document.getElementById('painelArea').classList.remove('hidden');
            document.getElementById('agendaIndividual').classList.add('hidden');
            
            document.getElementById('areaNome').textContent = area.nome;
            document.getElementById('areaCoordenador').textContent = `Coordenador: ${area.coordenador}`;
            
            renderizarEquipe(area);
            renderizarAtividades(area);
            
            atualizarBreadcrumb(`Dashboard > ${area.nome}`);
        }
        
        function renderizarEquipe(area) {
            const lista = document.getElementById('equipeLista');
            lista.innerHTML = '';
            
            area.equipe.forEach(membro => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 12px; background: #f9fafb; margin-bottom: 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s;';
                div.onmouseover = () => div.style.background = '#e5e7eb';
                div.onmouseout = () => div.style.background = '#f9fafb';
                div.onclick = () => mostrarAgendaIndividual(membro.nome, membro.cargo);
                
                div.innerHTML = `
                    <strong>${membro.nome}</strong><br>
                    <span style="color: #6b7280; font-size: 14px;">${membro.cargo}</span>
                    <span style="float: right; color: #3b82f6;">‚Üí</span>
                `;
                
                lista.appendChild(div);
            });
        }
        
        function renderizarAtividades(area) {
            const lista = document.getElementById('atividadesLista');
            lista.innerHTML = '';
            
            const atividadesFiltradas = estadoSistema.filtroAtual === 'todos' 
                ? area.atividades 
                : area.atividades.filter(a => a.status === estadoSistema.filtroAtual);
            
            atividadesFiltradas.forEach(atividade => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 12px; border: 1px solid #e5e7eb; margin-bottom: 12px; border-radius: 8px;';
                
                const diasRestantes = calcularDiasRestantes(atividade.prazo);
                
                const foiAdicionadoRecentemente = atividade.dataAdicionado && 
                    (new Date() - new Date(atividade.dataAdicionado)) < 24 * 60 * 60 * 1000;
                
                div.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="status-indicator status-${atividade.status}"></span>
                            <strong>${atividade.nome}</strong>
                            ${diasRestantes < 0 ? '<span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">ATRASADO</span>' : 
                              diasRestantes === 0 ? '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">HOJE</span>' :
                              diasRestantes <= 3 ? '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">URGENTE</span>' : ''}
                            ${foiAdicionadoRecentemente ? '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 4px;">NOVO</span>' : ''}
                        </div>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="gerenciarTarefas(${atividade.id})">üìã Tarefas</button>
                            <span class="edit-btn" onclick="editarAtividade(${atividade.id})">‚úèÔ∏è Editar</span>
                            <button class="btn btn-danger btn-sm" onclick="deletarAtividade(${atividade.id})">Excluir</button>
                        </div>
                    </div>
                    <div style="font-size: 13px; color: #6b7280; margin-top: 8px;">
                        ${atividade.responsaveis.join(', ')} - Prazo: ${formatarData(atividade.prazo)}
                    </div>
                    <div style="margin-top: 8px; display: flex; align-items: center; gap: 8px;">
                        <select onchange="mudarStatus(${atividade.id}, this.value)" style="padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                            <option value="verde" ${atividade.status === 'verde' ? 'selected' : ''}>üü¢ Em Dia</option>
                            <option value="amarelo" ${atividade.status === 'amarelo' ? 'selected' : ''}>üü° Aten√ß√£o</option>
                            <option value="vermelho" ${atividade.status === 'vermelho' ? 'selected' : ''}>üî¥ Atraso</option>
                        </select>
                        <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 12px; color: #6b7280;">Progresso:</span>
                            <input type="number" value="${calcularProgressoAtividade(atividade)}" min="0" max="100" 
                                   style="width: 50px; padding: 2px 4px; font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px;"
                                   readonly
                                   title="Progresso calculado automaticamente pelas tarefas">
                            <span>%</span>
                            <div style="flex: 1; background: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="width: ${calcularProgressoAtividade(atividade)}%; height: 100%; background: #3b82f6; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                    ${renderizarResumoTarefas(atividade)}
                `;
                
                div.setAttribute('data-atividade-id', atividade.id);
                
                lista.appendChild(div);
            });
            
            if (atividadesFiltradas.length === 0) {
                lista.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p>Nenhuma atividade encontrada.</p>
                    </div>
                `;
            }
        }
        
        function voltarDashboard() {
            document.getElementById('painelArea').classList.add('hidden');
            document.getElementById('agendaIndividual').classList.add('hidden');
            document.getElementById('dashboardExecutivo').classList.remove('hidden');
            document.getElementById('breadcrumb').classList.add('hidden');
            renderizarDashboard();
        }
        
        function voltarParaArea() {
            document.getElementById('agendaIndividual').classList.add('hidden');
            document.getElementById('painelArea').classList.remove('hidden');
            mostrarArea(estadoSistema.areaAtual);
        }
        
        // Fun√ß√µes de Eventos Avan√ßados
        function mostrarNovoEvento() {
            estadoSistema.editandoEvento = null;
            estadoSistema.pessoasSelecionadas.clear();
            estadoSistema.tarefasVinculadas.clear();
            
            document.getElementById('modalEventoTitulo').textContent = 'Novo Evento';
            document.getElementById('eventoId').value = '';
            
            document.getElementById('eventoTipo').value = 'reuniao';
            document.getElementById('eventoTitulo').value = '';
            document.getElementById('eventoDescricao').value = '';
            document.getElementById('eventoDiaCompleto').checked = false;
            document.getElementById('eventoHorarioInicio').value = '09:00';
            document.getElementById('eventoHorarioFim').value = '10:00';
            document.getElementById('eventoLocal').value = '';
            document.getElementById('eventoRecorrente').checked = false;
            document.getElementById('recorrenciaConfig').classList.add('hidden');
            
            document.querySelectorAll('#grupoDiasSemana input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            atualizarCamposEvento();
            atualizarListaPessoas();
            atualizarListaTarefasVinculadas();
            
            document.getElementById('modalEvento').classList.add('active');
        }
        
        function atualizarCamposEvento() {
            const tipo = document.getElementById('eventoTipo').value;
            const labelPessoas = document.getElementById('labelPessoas');
            const grupoLocal = document.getElementById('grupoLocal');
            
            switch(tipo) {
                case 'reuniao':
                    labelPessoas.textContent = 'Participantes';
                    grupoLocal.style.display = 'block';
                    break;
                case 'entrega':
                    labelPessoas.textContent = 'Respons√°veis pela Entrega';
                    grupoLocal.style.display = 'none';
                    break;
                case 'prazo':
                    labelPessoas.textContent = 'Respons√°veis';
                    grupoLocal.style.display = 'none';
                    break;
                case 'marco':
                    labelPessoas.textContent = 'Pessoas Envolvidas';
                    grupoLocal.style.display = 'none';
                    break;
                case 'outro':
                    labelPessoas.textContent = 'Pessoas Relacionadas';
                    grupoLocal.style.display = 'block';
                    break;
            }
        }
        
        function toggleHorarios() {
            const diaCompleto = document.getElementById('eventoDiaCompleto').checked;
            const grupoHorarios = document.getElementById('grupoHorarios');
            const grupoDataFim = document.getElementById('grupoDataFim');
            
            if (diaCompleto) {
                grupoHorarios.style.display = 'none';
                grupoDataFim.style.display = 'block';
            } else {
                grupoHorarios.style.display = 'grid';
                grupoDataFim.style.display = 'none';
                document.getElementById('eventoDataFim').value = '';
            }
        }
        
        function toggleRecorrencia() {
            const recorrente = document.getElementById('eventoRecorrente').checked;
            const config = document.getElementById('recorrenciaConfig');
            
            if (recorrente) {
                config.classList.remove('hidden');
                
                const dataEvento = document.getElementById('eventoData').value;
                if (dataEvento && document.getElementById('recorrenciaTipo').value === 'semanal') {
                    marcarDiaSemanaCorrespondente(dataEvento);
                }
            } else {
                config.classList.add('hidden');
            }
        }
        
        function atualizarConfigRecorrencia() {
            const tipo = document.getElementById('recorrenciaTipo').value;
            const grupoDias = document.getElementById('grupoDiasSemana');
            
            if (tipo === 'semanal' || tipo === 'personalizada') {
                grupoDias.classList.remove('hidden');
                
                const dataEvento = document.getElementById('eventoData').value;
                if (dataEvento) {
                    marcarDiaSemanaCorrespondente(dataEvento);
                }
            } else {
                grupoDias.classList.add('hidden');
            }
        }
        
        function marcarDiaSemanaCorrespondente(dataStr) {
            if (!dataStr) return;
            
            const data = new Date(dataStr + 'T00:00:00');
            const diaSemana = data.getDay();
            
            document.querySelectorAll('#grupoDiasSemana input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            const checkbox = document.querySelector(`#grupoDiasSemana input[value="${diaSemana}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        }
        
        function preencherSelectResponsaveis() {
            const select = document.getElementById('eventoPessoas');
            if (!select || !dados) return;
            
            select.innerHTML = '<option value="">Selecionar pessoa...</option>';
            
            const membrosUnicos = new Map();
            Object.values(dados.areas).forEach(area => {
                area.equipe.forEach(membro => {
                    if (!membrosUnicos.has(membro.nome)) {
                        membrosUnicos.set(membro.nome, {
                            nome: membro.nome,
                            cargo: membro.cargo,
                            area: area.nome
                        });
                    }
                });
            });
            
            const optionTodos = document.createElement('option');
            optionTodos.value = '_todos';
            optionTodos.textContent = 'üåê Toda Equipe';
            select.appendChild(optionTodos);
            
            Array.from(membrosUnicos.values())
                .sort((a, b) => a.nome.localeCompare(b.nome))
                .forEach(membro => {
                    const option = document.createElement('option');
                    option.value = membro.nome;
                    option.textContent = `${membro.nome} - ${membro.cargo}`;
                    select.appendChild(option);
                });
        }
        
        function adicionarPessoa() {
            const select = document.getElementById('eventoPessoas');
            const valor = select.value;
            
            if (!valor) return;
            
            if (valor === '_todos') {
                const membrosUnicos = new Set();
                Object.values(dados.areas).forEach(area => {
                    area.equipe.forEach(membro => {
                        membrosUnicos.add(membro.nome);
                    });
                });
                membrosUnicos.forEach(nome => estadoSistema.pessoasSelecionadas.add(nome));
            } else {
                estadoSistema.pessoasSelecionadas.add(valor);
            }
            
            select.value = '';
            atualizarListaPessoas();
        }
        
        function atualizarListaPessoas() {
            const container = document.getElementById('pessoasSelecionadas');
            container.innerHTML = '';
            
            Array.from(estadoSistema.pessoasSelecionadas).sort().forEach(pessoa => {
                const chip = document.createElement('div');
                chip.className = 'pessoa-chip';
                chip.innerHTML = `
                    ${pessoa}
                    <span class="remove" onclick="removerPessoa('${pessoa}')">√ó</span>
                `;
                container.appendChild(chip);
            });
        }
        
        function removerPessoa(nome) {
            estadoSistema.pessoasSelecionadas.delete(nome);
            atualizarListaPessoas();
        }
        
        function abrirSeletorTarefas() {
            const modal = document.getElementById('modalSeletorTarefas');
            modal.classList.add('active');
            filtrarTarefasVinculo();
        }
        
        function filtrarTarefasVinculo() {
            const busca = document.getElementById('buscarTarefaVinculo')?.value.toLowerCase() || '';
            const lista = document.getElementById('listaTarefasVinculo');
            lista.innerHTML = '';
            
            Object.entries(dados.areas).forEach(([areaKey, area]) => {
                const tarefasArea = [];
                
                area.atividades.forEach(atividade => {
                    if (!busca || atividade.nome.toLowerCase().includes(busca)) {
                        tarefasArea.push({
                            atividade: atividade,
                            area: area.nome
                        });
                    }
                    
                    if (atividade.tarefas) {
                        atividade.tarefas.forEach(tarefa => {
                            if (!busca || tarefa.descricao.toLowerCase().includes(busca)) {
                                tarefasArea.push({
                                    atividade: atividade,
                                    tarefa: tarefa,
                                    area: area.nome
                                });
                            }
                        });
                    }
                });
                
                if (tarefasArea.length > 0) {
                    const areaHeader = document.createElement('h4');
                    areaHeader.style.cssText = 'margin-top: 16px; margin-bottom: 8px; color: #374151;';
                    areaHeader.textContent = area.nome;
                    lista.appendChild(areaHeader);
                    
                    tarefasArea.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'tarefa-vinculo';
                        
                        const key = item.tarefa ? 
                            `${item.atividade.id}_${item.tarefa.id}` : 
                            `${item.atividade.id}`;
                        
                        const isSelected = estadoSistema.tarefasVinculadas.has(key);
                        
                        div.innerHTML = `
                            <input type="checkbox" 
                                   ${isSelected ? 'checked' : ''} 
                                   onchange="toggleTarefaVinculo('${key}', '${item.atividade.nome}', '${item.tarefa?.descricao || ''}')">
                            <div style="flex: 1;">
                                <strong>${item.atividade.nome}</strong>
                                ${item.tarefa ? `<br><span style="font-size: 12px; color: #6b7280;">‚Ü≥ ${item.tarefa.descricao}</span>` : ''}
                            </div>
                        `;
                        
                        lista.appendChild(div);
                    });
                }
            });
        }
        
        function toggleTarefaVinculo(key, nomeAtividade, nomeTarefa) {
            if (estadoSistema.tarefasVinculadas.has(key)) {
                estadoSistema.tarefasVinculadas.delete(key);
            } else {
                estadoSistema.tarefasVinculadas.set(key, {
                    nome: nomeTarefa ? `${nomeAtividade} - ${nomeTarefa}` : nomeAtividade
                });
            }
            atualizarListaTarefasVinculadas();
        }
        
        function atualizarListaTarefasVinculadas() {
            const container = document.getElementById('tarefasVinculadas');
            container.innerHTML = '';
            
            if (estadoSistema.tarefasVinculadas.size === 0) {
                container.innerHTML = '<div style="color: #6b7280; font-size: 13px;">Nenhuma tarefa vinculada</div>';
            } else {
                estadoSistema.tarefasVinculadas.forEach((info, key) => {
                    const div = document.createElement('div');
                    div.className = 'tarefa-vinculo';
                    div.innerHTML = `
                        üìã ${info.nome}
                        <span class="remove" onclick="removerTarefaVinculo('${key}')" style="cursor: pointer; color: #ef4444;">√ó</span>
                    `;
                    container.appendChild(div);
                });
            }
        }
        
        function removerTarefaVinculo(key) {
            estadoSistema.tarefasVinculadas.delete(key);
            atualizarListaTarefasVinculadas();
        }
        
        function fecharModalSeletorTarefas() {
            document.getElementById('modalSeletorTarefas').classList.remove('active');
        }
        
        
        // ========== SINCRONIZA√á√ÉO AUTOM√ÅTICA AGENDA PESSOAL ==========
        function sincronizarAgendasPessoais() {
            if (!dados || !estadoSistema.pessoaAtual) return;
            
            // Atualiza agenda da pessoa atual se estiver visualizando
            renderizarAgendaSemana(estadoSistema.pessoaAtual);
            
            console.log('Agendas pessoais sincronizadas automaticamente');
        }

        function atualizarTodasAgendasPessoais() {
            // For√ßa atualiza√ß√£o de todas as agendas pessoais quando h√° mudan√ßas no calend√°rio
            if (estadoSistema.pessoaAtual) {
                setTimeout(() => {
                    renderizarAgendaSemana(estadoSistema.pessoaAtual);
                }, 100);
            }
        }

        // ========== MELHORIAS DE INTEGRA√á√ÉO ==========
        function salvarDadosComSincronizacao() {
            salvarDados();
            sincronizarAgendasPessoais();
        }

        function salvarEvento() {
            if (!validarFormulario([
                {id: 'eventoData'},
                {id: 'eventoTitulo'}
            ])) {
                mostrarNotificacao('Preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }
            
            const diaCompleto = document.getElementById('eventoDiaCompleto').checked;
            
            if (!diaCompleto && !document.getElementById('eventoHorarioInicio').value) {
                document.getElementById('eventoHorarioInicio').classList.add('input-error');
                document.getElementById('eventoHorarioInicioError').classList.remove('hidden');
                mostrarNotificacao('Hor√°rio √© obrigat√≥rio!', 'error');
                return;
            }
            
            const evento = {
                id: estadoSistema.editandoEvento || Date.now(),
                titulo: document.getElementById('eventoTitulo').value,
                tipo: document.getElementById('eventoTipo').value,
                descricao: document.getElementById('eventoDescricao').value,
                data: document.getElementById('eventoData').value,
                diaCompleto: diaCompleto,
                horarioInicio: diaCompleto ? null : document.getElementById('eventoHorarioInicio').value,
                horarioFim: diaCompleto ? null : document.getElementById('eventoHorarioFim').value,
                dataFim: document.getElementById('eventoDataFim').value || null,
                local: document.getElementById('eventoLocal').value,
                pessoas: Array.from(estadoSistema.pessoasSelecionadas),
                tarefasRelacionadas: Array.from(estadoSistema.tarefasVinculadas.keys()).map(key => {
                    const [atividadeId, tarefaId] = key.split('_');
                    return {
                        atividadeId: parseInt(atividadeId),
                        tarefaId: tarefaId || null,
                        tipo: 'relacionada'
                    };
                })
            };
            
            if (document.getElementById('eventoRecorrente').checked) {
                const tipoRecorrencia = document.getElementById('recorrenciaTipo').value;
                evento.recorrencia = {
                    tipo: tipoRecorrencia,
                    fim: document.getElementById('recorrenciaFim').value || null
                };
                
                if (tipoRecorrencia === 'semanal' || tipoRecorrencia === 'personalizada') {
                    const diasSelecionados = [];
                    document.querySelectorAll('#grupoDiasSemana input[type="checkbox"]:checked').forEach(cb => {
                        diasSelecionados.push(parseInt(cb.value));
                    });
                    evento.recorrencia.diasSemana = diasSelecionados;
                }
            }
            
            if (estadoSistema.editandoEvento) {
                const index = dados.eventos.findIndex(e => e.id === estadoSistema.editandoEvento);
                if (index !== -1) {
                    dados.eventos[index] = evento;
                    mostrarNotificacao('Evento atualizado com sucesso!');
                    pararEditando('evento', estadoSistema.editandoEvento);
                }
            } else {
                dados.eventos.push(evento);
                mostrarNotificacao('Evento criado com sucesso!');
                
                registrarAtividade('evento_criado', {
                    titulo: evento.titulo,
                    tipo: evento.tipo,
                    data: evento.data
                });
            }
            
            salvarDados();
            fecharModal('modalEvento');
            gerarCalendario();
            atualizarEstatisticas();
            
            // ‚úÖ SINCRONIZA√á√ÉO AUTOM√ÅTICA ADICIONADA
            atualizarTodasAgendasPessoais();
        }
        
        function deletarEvento(id) {
            if (confirm('Deseja realmente excluir este evento? Se for recorrente, todas as ocorr√™ncias ser√£o removidas.')) {
                const evento = dados.eventos.find(e => e.id === id);
                dados.eventos = dados.eventos.filter(e => e.id !== id);
                
                salvarDados();
                gerarCalendario();
                atualizarEstatisticas();
                
                // ‚úÖ SINCRONIZA√á√ÉO AUTOM√ÅTICA ADICIONADA
                atualizarTodasAgendasPessoais();
                
                mostrarNotificacao(evento && evento.recorrencia ? 'Evento recorrente exclu√≠do!' : 'Evento exclu√≠do!');
            }
        }
        
        // Fun√ß√µes de Atividades
        function mostrarNovaAtividade() {
            estadoSistema.editandoAtividade = null;
            document.getElementById('modalAtividadeTitulo').textContent = 'Nova Atividade';
            document.getElementById('atividadeId').value = '';
            document.getElementById('atividadeProgresso').value = '';
            
            const select = document.getElementById('atividadeResponsaveis');
            select.innerHTML = '';
            
            const membrosMap = new Map();
            Object.entries(dados.areas).forEach(([areaKey, areaItem]) => {
                areaItem.equipe.forEach(membro => {
                    if (!membrosMap.has(membro.nome)) {
                        membrosMap.set(membro.nome, []);
                    }
                    membrosMap.get(membro.nome).push(areaItem.nome);
                });
            });
            
            Array.from(membrosMap.entries()).sort((a, b) => a[0].localeCompare(b[0])).forEach(([nomeMembro, areas]) => {
                const option = document.createElement('option');
                option.value = nomeMembro;
                option.textContent = `${nomeMembro} (${areas.join(', ')})`;
                if (estadoSistema.areaAtual && dados.areas[estadoSistema.areaAtual].equipe.some(m => m.nome === nomeMembro)) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            document.getElementById('modalAtividade').classList.add('active');
        }
        
        function editarAtividade(id) {
            const area = dados.areas[estadoSistema.areaAtual];
            const atividade = area.atividades.find(a => a.id === id);
            
            if (atividade) {
                estadoSistema.editandoAtividade = id;
                marcarEditando('atividade', id);
                
                document.getElementById('modalAtividadeTitulo').textContent = 'Editar Atividade';
                document.getElementById('atividadeId').value = id;
                document.getElementById('atividadeNome').value = atividade.nome;
                document.getElementById('atividadePrazo').value = atividade.prazo;
                document.getElementById('atividadeStatus').value = atividade.status;
                document.getElementById('atividadeProgresso').value = calcularProgressoAtividade(atividade);
                
                const select = document.getElementById('atividadeResponsaveis');
                select.innerHTML = '';
                
                const membrosMap = new Map();
                Object.entries(dados.areas).forEach(([areaKey, areaItem]) => {
                    areaItem.equipe.forEach(membro => {
                        if (!membrosMap.has(membro.nome)) {
                            membrosMap.set(membro.nome, []);
                        }
                        membrosMap.get(membro.nome).push(areaItem.nome);
                    });
                });
                
                Array.from(membrosMap.entries()).sort((a, b) => a[0].localeCompare(b[0])).forEach(([nomeMembro, areas]) => {
                    const option = document.createElement('option');
                    option.value = nomeMembro;
                    option.textContent = `${nomeMembro} (${areas.join(', ')})`;
                    option.selected = atividade.responsaveis.includes(nomeMembro);
                    select.appendChild(option);
                });
                
                document.getElementById('modalAtividade').classList.add('active');
            }
        }
        
        function salvarAtividade() {
            const responsaveisSelect = document.getElementById('atividadeResponsaveis');
            
            if (!validarFormulario([
                {id: 'atividadeNome'},
                {id: 'atividadePrazo'},
                {id: 'atividadeResponsaveis', tipo: 'select'}
            ])) {
                mostrarNotificacao('Preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }

            // Validar prazo
            if (!validarPrazoAtividade()) {
                return;
            }
            
            const area = dados.areas[estadoSistema.areaAtual];
            const responsaveis = Array.from(responsaveisSelect.selectedOptions).map(opt => opt.value);
            
            const atividadeData = {
                nome: document.getElementById('atividadeNome').value,
                prazo: document.getElementById('atividadePrazo').value,
                responsaveis: responsaveis,
                status: document.getElementById('atividadeStatus').value
            };
            
            if (estadoSistema.editandoAtividade) {
                const index = area.atividades.findIndex(a => a.id === estadoSistema.editandoAtividade);
                if (index !== -1) {
                    area.atividades[index] = {
                        ...area.atividades[index],
                        ...atividadeData
                    };
                    
                    registrarAtividade('atividade_editada', {
                        nome: atividadeData.nome,
                        area: area.nome
                    });
                    
                    pararEditando('atividade', estadoSistema.editandoAtividade);
                }
            } else {
                const novaAtividade = {
                    id: Date.now(),
                    ...atividadeData,
                    progresso: 0,
                    dataAdicionado: new Date().toISOString(),
                    tarefas: []
                };
                
                area.atividades.push(novaAtividade);
                
                registrarAtividade('atividade_criada', {
                    nome: atividadeData.nome,
                    area: area.nome,
                    responsaveis: responsaveis
                });
            }
            
            salvarDados();
            fecharModal('modalAtividade');
            renderizarAtividades(area);
            atualizarEstatisticas();
            mostrarNotificacao('Atividade salva com sucesso!');
        }
        
        function deletarAtividade(id) {
            if (confirm('Deseja realmente excluir esta atividade?')) {
                const area = dados.areas[estadoSistema.areaAtual];
                const atividade = area.atividades.find(a => a.id === id);
                
                area.atividades = area.atividades.filter(a => a.id !== id);
                
                if (atividade) {
                    registrarAtividade('atividade_excluida', {
                        nome: atividade.nome,
                        area: area.nome
                    });
                }
                
                salvarDados();
                renderizarAtividades(area);
                atualizarEstatisticas();
                mostrarNotificacao('Atividade exclu√≠da!');
            }
        }
        
        function mudarStatus(id, novoStatus) {
            const area = dados.areas[estadoSistema.areaAtual];
            const atividade = area.atividades.find(a => a.id === id);
            if (atividade) {
                const statusAnterior = atividade.status;
                atividade.status = novoStatus;
                
                registrarAtividade('status_alterado', {
                    atividade: atividade.nome,
                    de: statusAnterior,
                    para: novoStatus
                });
                
                salvarDados();
                atualizarEstatisticas();
            }
        }
        
        // ========== FUN√á√ïES DE TAREFAS MELHORADAS ==========
        function calcularProgressoAtividade(atividade) {
            if (!atividade.tarefas || atividade.tarefas.length === 0) {
                return atividade.progresso || 0;
            }
            
            let totalSubtarefas = 0;
            let subtarefasConcluidas = 0;
            
            atividade.tarefas.forEach(tarefa => {
                if (tarefa.subtarefas && tarefa.subtarefas.length > 0) {
                    totalSubtarefas += tarefa.subtarefas.length;
                    subtarefasConcluidas += tarefa.subtarefas.filter(st => st.status === 'concluida').length;
                } else {
                    totalSubtarefas += 1;
                    if (tarefa.status === 'concluida') subtarefasConcluidas += 1;
                }
            });
            
            return totalSubtarefas > 0 ? Math.round((subtarefasConcluidas / totalSubtarefas) * 100) : 0;
        }
        
        function renderizarResumoTarefas(atividade) {
            if (!atividade.tarefas || atividade.tarefas.length === 0) {
                return `
                    <div style="margin-top: 12px; padding: 8px; background: #fef3c7; border-radius: 6px; font-size: 12px;">
                        ‚ö†Ô∏è Nenhuma tarefa definida. <a href="#" onclick="event.preventDefault(); gerenciarTarefas(${atividade.id})" style="color: #3b82f6;">Adicionar tarefas</a>
                    </div>
                `;
            }
            
            const totalTarefas = atividade.tarefas.length;
            const tarefasConcluidas = atividade.tarefas.filter(t => t.status === 'concluida').length;
            const tarefasBloqueadas = contarTarefasBloqueadas(atividade);
            const proximaTarefa = obterProximaTarefa(atividade);
            
            return `
                <div style="margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 6px; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span class="contador-tarefas">
                                ‚úÖ ${tarefasConcluidas}/${totalTarefas} tarefas
                                ${tarefasBloqueadas > 0 ? `<span style="color: #ef4444;">üîí ${tarefasBloqueadas} bloqueadas</span>` : ''}
                            </span>
                        </div>
                        ${proximaTarefa ? `
                            <div style="color: #6b7280;">
                                Pr√≥xima: <strong>${proximaTarefa.descricao}</strong>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function contarTarefasBloqueadas(atividade) {
            if (!atividade.tarefas) return 0;
            
            return atividade.tarefas.filter(tarefa => {
                if (!tarefa.dependencias || tarefa.dependencias.length === 0) return false;
                
                return tarefa.dependencias.some(dep => {
                    const tarefaDependente = atividade.tarefas.find(t => t.descricao === dep);
                    return tarefaDependente && tarefaDependente.status !== 'concluida';
                });
            }).length;
        }
        
        function obterProximaTarefa(atividade) {
            if (!atividade.tarefas) return null;
            
            return atividade.tarefas.find(tarefa => {
                if (tarefa.status === 'concluida') return false;
                
                if (tarefa.dependencias && tarefa.dependencias.length > 0) {
                    const bloqueada = tarefa.dependencias.some(dep => {
                        const tarefaDependente = atividade.tarefas.find(t => t.descricao === dep);
                        return tarefaDependente && tarefaDependente.status !== 'concluida';
                    });
                    if (bloqueada) return false;
                }
                
                return true;
            });
        }
        
        function gerenciarTarefas(atividadeId) {
            const area = dados.areas[estadoSistema.areaAtual];
            const atividade = area.atividades.find(a => a.id === atividadeId);
            
            if (!atividade) return;
            
            mostrarModalTarefas(atividade);
        }
        
        function mostrarModalTarefas(atividade) {
            let modal = document.getElementById('modalTarefas');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modalTarefas';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h3>üìã Gerenciar Tarefas: ${atividade.nome}</h3>
                            <p style="color: #6b7280; font-size: 14px; margin-top: 4px;">
                                Prazo da responsabilidade: ${formatarData(atividade.prazo)} | 
                                Progresso: ${calcularProgressoAtividade(atividade)}%
                            </p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-template btn-sm" onclick="aplicarTemplate(${atividade.id})">
                                üìÑ Aplicar Template
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="adicionarTarefa(${atividade.id})">
                                + Nova Tarefa
                            </button>
                        </div>
                    </div>
                    
                    <div id="listaTarefas" style="max-height: 500px; overflow-y: auto;">
                        ${renderizarListaTarefas(atividade)}
                    </div>
                    
                    <div style="margin-top: 24px; display: flex; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="fecharModalTarefas()">Fechar</button>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function renderizarListaTarefas(atividade) {
            if (!atividade.tarefas || atividade.tarefas.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p style="font-size: 48px; margin-bottom: 16px;">üìã</p>
                        <p>Nenhuma tarefa cadastrada ainda.</p>
                        <p style="font-size: 14px; margin-top: 8px;">
                            Adicione tarefas manualmente ou aplique um template.
                        </p>
                    </div>
                `;
            }
            
            return atividade.tarefas.map((tarefa, index) => {
                const bloqueada = verificarTarefaBloqueada(tarefa, atividade);
                
                return `
                    <div class="tarefa-item ${bloqueada ? 'dependencia-bloqueada' : ''}" id="tarefa_${tarefa.id}">
                        <div class="tarefa-header">
                            ${tarefa.subtarefas && tarefa.subtarefas.length > 0 ? `
                                <span class="tarefa-expandir" onclick="toggleSubtarefas('${tarefa.id}')">‚ñ∂</span>
                            ` : '<span style="width: 20px;"></span>'}
                            
                            <input type="checkbox" 
                                   class="tarefa-checkbox" 
                                   ${tarefa.status === 'concluida' ? 'checked' : ''}
                                   ${bloqueada ? 'disabled' : ''}
                                   onchange="toggleTarefa(${atividade.id}, '${tarefa.id}')">
                            
                            <span class="tarefa-descricao ${tarefa.status === 'concluida' ? 'concluida' : ''}">
                                ${tarefa.descricao}
                            </span>
                            
                            <div class="tarefa-info">
                                ${tarefa.prioridade ? `
                                    <span class="prioridade-${tarefa.prioridade}">
                                        ${tarefa.prioridade === 'alta' ? 'üî¥' : tarefa.prioridade === 'media' ? 'üü°' : 'üü¢'}
                                        ${tarefa.prioridade}
                                    </span>
                                ` : ''}
                                
                                ${tarefa.responsavel ? `
                                    <span>üë§ ${tarefa.responsavel}</span>
                                ` : ''}
                                
                                ${tarefa.prazo ? `
                                    <span>üìÖ ${formatarData(tarefa.prazo)}</span>
                                ` : ''}
                                
                                ${tarefa.dependencias && tarefa.dependencias.length > 0 ? `
                                    <span title="Depende de: ${tarefa.dependencias.join(', ')}">
                                        üîó ${tarefa.dependencias.length} dep.
                                    </span>
                                ` : ''}
                                
                                <button class="btn btn-primary btn-sm" onclick="editarTarefaModal(${atividade.id}, '${tarefa.id}')">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deletarTarefaItem(${atividade.id}, '${tarefa.id}')">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        
                        ${tarefa.subtarefas && tarefa.subtarefas.length > 0 ? `
                            <div class="subtarefas-container" id="subtarefas_${tarefa.id}" style="display: none;">
                                ${tarefa.subtarefas.map((subtarefa, subIndex) => `
                                    <div class="subtarefa-item">
                                        <input type="checkbox" 
                                               class="tarefa-checkbox" 
                                               ${subtarefa.status === 'concluida' ? 'checked' : ''}
                                               onchange="toggleSubtarefa(${atividade.id}, '${tarefa.id}', '${subtarefa.id}')">
                                        
                                        <span class="${subtarefa.status === 'concluida' ? 'concluida' : ''}">
                                            ${subtarefa.descricao}
                                        </span>
                                        
                                        ${subtarefa.responsavel ? `
                                            <span style="font-size: 11px; color: #6b7280;">
                                                üë§ ${subtarefa.responsavel}
                                            </span>
                                        ` : ''}
                                    </div>
                                `).join('')}
                                
                                <div style="margin-top: 8px;">
                                    <button class="btn btn-primary btn-sm" onclick="adicionarSubtarefa(${atividade.id}, '${tarefa.id}')">
                                        + Adicionar subtarefa
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function editarTarefaModal(atividadeId, tarefaId) {
            const area = dados.areas[estadoSistema.areaAtual];
            const atividade = area.atividades.find(a => a.id === atividadeId);
            const tarefa = atividade.tarefas.find(t => t.id === tarefaId);
            
            if (!tarefa) return;

            estadoSistema.editandoTarefa = {atividadeId, tarefaId};
            
            // Preencher respons√°veis
            const selectResponsavel = document.getElementById('editTarefaResponsavel');
            selectResponsavel.innerHTML = '';
            
            atividade.responsaveis.forEach(responsavel => {
                const option = document.createElement('option');
                option.value = responsavel;
                option.textContent = responsavel;
                option.selected = tarefa.responsavel === responsavel;
                selectResponsavel.appendChild(option);
            });

            // Preencher depend√™ncias
            const containerDependencias = document.getElementById('editTarefaDependencias');
            containerDependencias.innerHTML = '';
            
            atividade.tarefas.forEach(outraTarefa => {
                if (outraTarefa.id !== tarefaId) {
                    const div = document.createElement('div');
                    div.style.cssText = 'margin-bottom: 8px;';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = outraTarefa.descricao;
                    checkbox.checked = tarefa.dependencias && tarefa.dependencias.includes(outraTarefa.descricao);
                    checkbox.style.marginRight = '8px';
                    
                    const label = document.createElement('label');
                    label.style.cssText = 'display: flex; align-items: center; cursor: pointer; font-size: 13px;';
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(outraTarefa.descricao));
                    
                    div.appendChild(label);
                    containerDependencias.appendChild(div);
                }
            });

            // Preencher campos
            document.getElementById('editTarefaAtividadeId').value = atividadeId;
            document.getElementById('editTarefaId').value = tarefaId;
            document.getElementById('editTarefaDescricao').value = tarefa.descricao || '';
            document.getElementById('editTarefaPrioridade').value = tarefa.prioridade || 'media';
            document.getElementById('editTarefaPrazo').value = tarefa.prazo || '';
            document.getElementById('editTarefaObservacoes').value = tarefa.observacoes || '';

            document.getElementById('modalEditarTarefa').classList.add('active');
        }

        function salvarEdicaoTarefa() {
            const atividadeId = parseInt(document.getElementById('editTarefaAtividadeId').value);
            const tarefaId = document.getElementById('editTarefaId').value;
            
            if (!validarFormulario([{id: 'editTarefaDescricao'}])) {
                mostrarNotificacao('Preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }

            const area = dados.areas[estadoSistema.areaAtual];
            const atividade = area.atividades.find(a => a.id === atividadeId);
            const tarefa = atividade.tarefas.find(t => t.id === tarefaId);

            if (!tarefa) return;

            // Coletar depend√™ncias selecionadas
            const dependenciasSelecionadas = [];
            document.querySelectorAll('#editTarefaDependencias input[type="checkbox"]:checked').forEach(cb => {
                dependenciasSelecionadas.push(cb.value);
            });

            // Atualizar tarefa
            tarefa.descricao = document.getElementById('editTarefaDescricao').value;
            tarefa.prioridade = document.getElementById('editTarefaPrioridade').value;
            tarefa.responsavel = document.getElementById('editTarefaResponsavel').value;
            tarefa.prazo = document.getElementById('editTarefaPrazo').value;
            tarefa.dependencias = dependenciasSelecionadas;
            tarefa.observacoes = document.getElementById('editTarefaObservacoes').value;

            registrarAtividade('tarefa_editada', {
                tarefa: tarefa.descricao,
                atividade: atividade.nome
            });

            salvarDados();
            fecharModal('modalEditarTarefa');
            mostrarModalTarefas(atividade);
            mostrarNotificacao('Tarefa editada com sucesso!');
        }
        
        function verificarTarefaBloqueada(tarefa, atividade) {
            if (!tarefa.dependencias || tarefa.dependencias.length === 0) return false;
            
            return tarefa.dependencias.some(dep => {
                const tarefaDependente = atividade.tarefas.find(t => t.descricao === dep);
                return tarefaDependente && tarefaDependente.status !== 'concluida';
            });
        }
        
        function toggleSubtarefas(tarefaId) {
            const container = document.getElementById(`subtarefas_${tarefaId}`);
            const expandir = container.parentElement.querySelector('.tarefa-expandir');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                expandir.classList.add('expandido');
            } else {
                container.style.display = 'none';
                expandir.classList.remove('expandido');
            }
        }

        function toggleTarefa(atividadeId, tarefaId) {
            const area = dados.areas[estadoSistema.areaAtual];
            const atividade = area.atividades.find(a => a.id === atividadeId);
            const tarefa = atividade.tarefas.find(t => t.id === tarefaId);
            
            if (tarefa) {
                if (tarefa.subtarefas && tarefa.subtarefas.length > 0) {
                    const subtarefasPendentes = tarefa.subtarefas.filter(st => st.status !== 'concluida').length;
                    if (subtarefasPendentes > 0 && tarefa.status !== 'concluida') {
                        mostrarNotificacao(`Conclua todas as ${subtarefasPendentes} subtarefas primeiro!`, 'error');
                        mostrarModalTarefas(atividade);
                        return;
                    }
                }
                
                tarefa.status = tarefa.status === 'concluida' ? 'pendente' : 'concluida';
                
                if (tarefa.status === 'concluida' && tarefa.subtarefas) {
                    tarefa.subtarefas.forEach(st => st.status = 'concluida');
                }
                
                const novoProgresso = calcularProgressoAtividade(atividade);
                atividade.progresso = novoProgresso;
                
                if (novoProgresso === 100) {
                    atividade.status = 'verde';
                    mostrarNotificacao('üéâ Todas as tarefas conclu√≠das! Responsabilidade completa!');
                }
                
                salvarDados();
                mostrarModalTarefas(atividade);
            }
        }
        
        function toggleSubtarefa(atividadeId, tarefaId, subtarefaId) {
            const area = dados.areas[estadoSistema.areaAtual];
            const atividade = area.atividades.find(a => a.id === atividadeId);
            const tarefa = atividade.tarefas.find(t => t.id === tarefaId);
            const subtarefa = tarefa.subtarefas.find(st => st.id === subtarefaId);
            
            if (subtarefa) {
                subtarefa.status = subtarefa.status === 'concluida' ? 'pendente' : 'concluida';
                
                const todasConcluidas = tarefa.subtarefas.every(st => st.status === 'concluida');
                if (todasConcluidas && tarefa.status !== 'concluida') {
                    mostrarNotificacao('Todas as subtarefas conclu√≠das! Voc√™ pode marcar a tarefa principal agora.');
                }
                
                const novoProgresso = calcularProgressoAtividade(atividade);
                atividade.progresso = novoProgresso;
                
                salvarDados();
                mostrarModalTarefas(atividade);
            }
        }
        
        function adicionarTarefa(atividadeId) {
            const descricao = prompt('Digite a descri√ß√£o da nova tarefa:');
            if (!descricao) return;
            
            const area = dados.areas[estadoSistema.areaAtual];
            const atividade = area.atividades.find(a => a.id === atividadeId);
            
            if (!atividade.tarefas) atividade.tarefas = [];
            
            const novaTarefa = {
                id: `${atividadeId}_T${Date.now()}`,
                descricao: descricao,
                tipo: 'tarefa',
                status: 'pendente',
                responsavel: atividade.responsaveis[0] || '',
                prioridade: 'media',
                subtarefas: [],
                dependencias: [],
                observacoes: ''
            };
            
            atividade.tarefas.push(novaTarefa);
            salvarDados();
            mostrarModalTarefas(atividade);
            mostrarNotificacao('Tarefa adicionada com sucesso!');
        }
        
        function aplicarTemplate(atividadeId) {
            const templates = obterTemplatesPadrao();
            const area = dados.areas[estadoSistema.areaAtual];
            const atividade = area.atividades.find(a => a.id === atividadeId);
            
            const template = templates.asBuilt;
            
            if (confirm('Aplicar template "As Built"? Isso substituir√° as tarefas existentes.')) {
                atividade.tarefas = JSON.parse(JSON.stringify(template.tarefas));
                
                atividade.tarefas.forEach((tarefa, index) => {
                    tarefa.id = `${atividadeId}_T${Date.now()}_${index}`;
                    tarefa.responsavel = atividade.responsaveis[0] || '';
                    
                    if (tarefa.subtarefas) {
                        tarefa.subtarefas.forEach((sub, subIndex) => {
                            sub.id = `${tarefa.id}_S${subIndex + 1}`;
                            sub.responsavel = tarefa.responsavel;
                        });
                    }
                });
                
                salvarDados();
                mostrarModalTarefas(atividade);
                mostrarNotificacao('Template aplicado com sucesso!');
            }
        }
        
        function deletarTarefaItem(atividadeId, tarefaId) {
            if (confirm('Deseja realmente excluir esta tarefa?')) {
                const area = dados.areas[estadoSistema.areaAtual];
                const atividade = area.atividades.find(a => a.id === atividadeId);
                
                atividade.tarefas = atividade.tarefas.filter(t => t.id !== tarefaId);
                
                salvarDados();
                mostrarModalTarefas(atividade);
                mostrarNotificacao('Tarefa exclu√≠da!');
            }
        }
        
        function adicionarSubtarefa(atividadeId, tarefaId) {
            const descricao = prompt('Digite a descri√ß√£o da subtarefa:');
            if (!descricao) return;
            
            const area = dados.areas[estadoSistema.areaAtual];
            const atividade = area.atividades.find(a => a.id === atividadeId);
            const tarefa = atividade.tarefas.find(t => t.id === tarefaId);
            
            if (!tarefa.subtarefas) tarefa.subtarefas = [];
            
            const novaSubtarefa = {
                id: `${tarefaId}_S${Date.now()}`,
                descricao: descricao,
                status: 'pendente',
                responsavel: tarefa.responsavel || ''
            };
            
            tarefa.subtarefas.push(novaSubtarefa);
            salvarDados();
            mostrarModalTarefas(atividade);
            mostrarNotificacao('Subtarefa adicionada!');
        }
        
        function fecharModalTarefas() {
            const modal = document.getElementById('modalTarefas');
            if (modal) {
                modal.classList.remove('active');
            }
            
            const area = dados.areas[estadoSistema.areaAtual];
            renderizarAtividades(area);
            atualizarEstatisticas();
        }

        function obterTemplatesPadrao() {
            return {
                asBuilt: {
                    nome: "As Built",
                    tarefas: [
                        {
                            descricao: "Levantamento de Campo",
                            tipo: "tarefa",
                            status: "pendente",
                            prioridade: "alta",
                            dependencias: [],
                            subtarefas: [
                                { descricao: "Medi√ß√£o T√©rreo", tipo: "subtarefa", status: "pendente" },
                                { descricao: "Medi√ß√£o 1¬∫ Pavimento", tipo: "subtarefa", status: "pendente" },
                                { descricao: "Medi√ß√£o 2¬∫ Pavimento", tipo: "subtarefa", status: "pendente" },
                                { descricao: "Confer√™ncia de Medidas", tipo: "subtarefa", status: "pendente" }
                            ]
                        },
                        {
                            descricao: "Desenho T√©cnico",
                            tipo: "tarefa",
                            status: "pendente",
                            prioridade: "alta",
                            dependencias: ["Levantamento de Campo"],
                            subtarefas: [
                                { descricao: "Plantas Baixas", tipo: "subtarefa", status: "pendente" },
                                { descricao: "Cortes", tipo: "subtarefa", status: "pendente" },
                                { descricao: "Fachadas", tipo: "subtarefa", status: "pendente" },
                                { descricao: "Detalhamentos", tipo: "subtarefa", status: "pendente" }
                            ]
                        },
                        {
                            descricao: "Revis√£o T√©cnica",
                            tipo: "tarefa",
                            status: "pendente",
                            prioridade: "media",
                            dependencias: ["Desenho T√©cnico"],
                            subtarefas: [
                                { descricao: "Revis√£o Interna", tipo: "subtarefa", status: "pendente" },
                                { descricao: "Corre√ß√µes", tipo: "subtarefa", status: "pendente" },
                                { descricao: "Aprova√ß√£o Coordenador", tipo: "subtarefa", status: "pendente" }
                            ]
                        },
                        {
                            descricao: "Entrega Final",
                            tipo: "tarefa",
                            status: "pendente",
                            prioridade: "alta",
                            dependencias: ["Revis√£o T√©cnica"],
                            subtarefas: [
                                { descricao: "Gerar PDFs", tipo: "subtarefa", status: "pendente" },
                                { descricao: "Organizar Arquivos", tipo: "subtarefa", status: "pendente" },
                                { descricao: "Upload no Sistema", tipo: "subtarefa", status: "pendente" },
                                { descricao: "Notificar Cliente", tipo: "subtarefa", status: "pendente" }
                            ]
                        }
                    ]
                }
            };
        }
        
        // Fun√ß√µes de Agenda Individual
        function mostrarAgendaIndividual(nome, cargo) {
            estadoSistema.pessoaAtual = nome;
            
            document.getElementById('painelArea').classList.add('hidden');
            document.getElementById('agendaIndividual').classList.remove('hidden');
            
            document.getElementById('pessoaNome').textContent = nome;
            document.getElementById('pessoaCargo').textContent = cargo;
            
            renderizarResponsabilidades(nome);
            renderizarAgendaSemana(nome);
            carregarObservacoes(nome);
            
            const area = dados.areas[estadoSistema.areaAtual];
            atualizarBreadcrumb(`Dashboard > ${area.nome} > ${nome}`);
        }
        
        function renderizarResponsabilidades(nome) {
            const lista = document.getElementById('responsabilidadesLista');
            lista.innerHTML = '';
            let totalResponsabilidades = 0;
            let responsabilidades = [];
            
            Object.entries(dados.areas).forEach(([areaKey, area]) => {
                area.atividades.forEach(atividade => {
                    if (atividade.responsaveis.includes(nome)) {
                        totalResponsabilidades++;
                        responsabilidades.push({
                            atividade: atividade,
                            areaKey: areaKey,
                            areaNome: area.nome,
                            prazoData: new Date(atividade.prazo)
                        });
                    }
                });
            });
            
            responsabilidades.sort((a, b) => a.prazoData - b.prazoData);
            
            const filtro = document.getElementById('filtroResponsabilidades')?.value || 'todas';
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            const responsabilidadesFiltradas = responsabilidades.filter(({atividade}) => {
                const prazo = new Date(atividade.prazo);
                prazo.setHours(0, 0, 0, 0);
                const diasRestantes = Math.floor((prazo - hoje) / (1000 * 60 * 60 * 24));
                
                switch(filtro) {
                    case 'urgentes':
                        return diasRestantes <= 3 && diasRestantes >= 0;
                    case 'atrasadas':
                        return diasRestantes < 0;
                    case 'emdia':
                        return atividade.status === 'verde';
                    case 'atencao':
                        return atividade.status === 'amarelo';
                    default:
                        return true;
                }
            });
            
            responsabilidadesFiltradas.forEach(({atividade, areaKey, areaNome}) => {
                const div = document.createElement('div');
                
                const diasRestantes = calcularDiasRestantes(atividade.prazo);
                
                div.style.cssText = `padding: 12px; border: 1px solid #e5e7eb; margin-bottom: 12px; border-radius: 8px; position: relative; ${diasRestantes < 0 ? 'border-color: #ef4444; background: #fee2e2;' : diasRestantes <= 3 ? 'border-color: #f59e0b; background: #fef3c7;' : ''}`;
                
                const foiAdicionadoRecentemente = atividade.dataAdicionado && 
                    (new Date() - new Date(atividade.dataAdicionado)) < 24 * 60 * 60 * 1000;
                
                let prazoTexto = '';
                let prazoCor = '';
                if (diasRestantes < 0) {
                    prazoTexto = `‚ö†Ô∏è Atrasado ${Math.abs(diasRestantes)} dias`;
                    prazoCor = 'color: #ef4444;';
                } else if (diasRestantes === 0) {
                    prazoTexto = 'üìÖ Vence hoje!';
                    prazoCor = 'color: #f59e0b; font-weight: bold;';
                } else if (diasRestantes <= 3) {
                    prazoTexto = `‚è∞ ${diasRestantes} dias restantes`;
                    prazoCor = 'color: #f59e0b;';
                } else {
                    prazoTexto = `üìÖ ${diasRestantes} dias restantes`;
                    prazoCor = 'color: #10b981;';
                }
                
                div.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="status-indicator status-${atividade.status}"></span>
                            <strong>${atividade.nome}</strong>
                            ${foiAdicionadoRecentemente ? '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">NOVO</span>' : ''}
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button class="btn btn-primary btn-sm" onclick="gerenciarTarefasResponsabilidade(${atividade.id}, '${areaKey}')">
                                üìã Tarefas
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="editarResponsabilidade(${atividade.id}, '${areaKey}')">
                                ‚úèÔ∏è Editar
                            </button>
                            ${atividade.responsaveis.length > 1 ? 
                                `<button class="btn btn-danger btn-sm" onclick="removerResponsabilidade(${atividade.id}, '${areaKey}', '${nome}')" title="Remover-me desta atividade">
                                    ‚ùå Sair
                                </button>` : ''}
                        </div>
                    </div>
                    <div style="font-size: 13px; color: #6b7280;">
                        ${areaNome}<br>
                        Prazo: ${formatarData(atividade.prazo)} <span style="${prazoCor}">${prazoTexto}</span><br>
                        Respons√°veis: ${atividade.responsaveis.join(', ')}
                    </div>
                    <div style="margin-top: 8px; display: flex; align-items: center; gap: 8px;">
                        <select onchange="mudarStatusResponsabilidade(${atividade.id}, '${areaKey}', this.value)" 
                                style="padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                            <option value="verde" ${atividade.status === 'verde' ? 'selected' : ''}>üü¢ Em Dia</option>
                            <option value="amarelo" ${atividade.status === 'amarelo' ? 'selected' : ''}>üü° Aten√ß√£o</option>
                            <option value="vermelho" ${atividade.status === 'vermelho' ? 'selected' : ''}>üî¥ Atraso</option>
                        </select>
                        <div style="flex: 1;">
                            <input type="number" value="${calcularProgressoAtividade(atividade)}" min="0" max="100" 
                                   style="width: 45px; padding: 2px 4px; font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px; margin-right: 4px;"
                                   readonly title="Progresso calculado automaticamente pelas tarefas">
                            <span style="font-size: 11px;">%</span>
                            <div style="background: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 4px;">
                                <div style="width: ${calcularProgressoAtividade(atividade)}%; height: 100%; background: #3b82f6;"></div>
                            </div>
                        </div>
                    </div>
                    ${renderizarResumoTarefasCompacto(atividade)}
                `;
                
                lista.appendChild(div);
            });
            
            const contador = document.getElementById('contadorResponsabilidades');
            if (contador) {
                const totalReal = totalResponsabilidades;
                const totalFiltrado = responsabilidadesFiltradas.length;
                
                if (filtro !== 'todas' && totalFiltrado !== totalReal) {
                    contador.textContent = `${totalFiltrado}/${totalReal}`;
                } else {
                    contador.textContent = totalReal;
                }
                contador.style.background = totalReal > 5 ? '#fbbf24' : '#e5e7eb';
            }
            
            if (totalResponsabilidades === 0) {
                lista.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p style="font-size: 48px; margin-bottom: 16px;">üìã</p>
                        <p>Voc√™ ainda n√£o tem responsabilidades atribu√≠das.</p>
                        <p style="font-size: 14px; margin-top: 8px;">Entre em contato com seu coordenador para receber tarefas.</p>
                    </div>
                `;
            } else if (responsabilidadesFiltradas.length === 0) {
                lista.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p style="font-size: 32px; margin-bottom: 16px;">üîç</p>
                        <p>Nenhuma responsabilidade encontrada com este filtro.</p>
                        <p style="font-size: 14px; margin-top: 8px;">Tente mudar o filtro para ver outras responsabilidades.</p>
                    </div>
                `;
            }
        }
        
        function renderizarAgendaSemana(nome) {
            const container = document.getElementById('agendaSemana');
            container.innerHTML = '';
            
            const diasSemana = ['segunda', 'terca', 'quarta', 'quinta', 'sexta'];
            const diasNomes = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta'];
            
            diasSemana.forEach((dia, index) => {
                const diaDiv = document.createElement('div');
                diaDiv.className = 'dia-semana';
                
                const hoje = new Date();
                const diaSemanaAtual = hoje.getDay();
                const diasParaAdicionar = index + 1 - diaSemanaAtual;
                const dataDodia = new Date(hoje);
                dataDodia.setDate(hoje.getDate() + diasParaAdicionar);
                const dataFormatada = dataDodia.toISOString().split('T')[0];
                
                const statusDia = dados.statusPessoal?.[nome]?.[dataFormatada];
                
                diaDiv.innerHTML = `<h4 style="margin-bottom: 12px; color: #1f2937;">${diasNomes[index]}</h4>`;
                
                if (statusDia) {
                    const badgeDiv = document.createElement('div');
                    badgeDiv.className = `status-badge ${statusDia.tipo === 'ausencia' ? 'status-ausencia' : 'status-home-office'}`;
                    badgeDiv.textContent = statusDia.tipo === 'ausencia' ? 'Ausente' : 'Home Office';
                    diaDiv.appendChild(badgeDiv);
                }
                
                if (dados.agendas[nome] && dados.agendas[nome][dia]) {
                    dados.agendas[nome][dia].forEach(tarefa => {
                        const tarefaDiv = document.createElement('div');
                        let classeTarefa = 'tarefa';
                        if (tarefa.mostrarNoCalendario) classeTarefa += ' tarefa-global';
                        if (tarefa.recorrencia && tarefa.recorrencia !== 'unica') classeTarefa += ' tarefa-recorrente';
                        
                        tarefaDiv.className = classeTarefa;
                        tarefaDiv.innerHTML = `
                            ${tarefa.descricao}
                            ${tarefa.mostrarNoCalendario ? '<span style="font-size: 11px;">üìÖ</span>' : ''}
                            ${tarefa.recorrencia && tarefa.recorrencia !== 'unica' ? `<span style="font-size: 11px;">üîÑ ${tarefa.recorrencia}</span>` : ''}
                            <span class="delete-btn" onclick="deletarTarefa('${nome}', '${dia}', '${tarefa.id}')">√ó</span>
                        `;
                        diaDiv.appendChild(tarefaDiv);
                    });
                }
                
                const eventosDia = obterEventosDoDia(dataFormatada);
                const eventosRelevantes = eventosDia.filter(evento => 
                    evento.pessoas && (evento.pessoas.includes(nome) || evento.pessoas.includes('Todos'))
                );
                
                eventosRelevantes.forEach(evento => {
                    const eventoDiv = document.createElement('div');
                    eventoDiv.className = 'tarefa';
                    
                    let corFundo = '#bfdbfe';
                    let icone = 'üìÖ';
                    switch(evento.tipo) {
                        case 'entrega': corFundo = '#bbf7d0'; icone = 'üì¶'; break;
                        case 'prazo': corFundo = '#fecaca'; icone = '‚è∞'; break;
                        case 'marco': corFundo = '#ddd6fe'; icone = 'üéØ'; break;
                        case 'outro': corFundo = '#e5e7eb'; icone = 'üìå'; break;
                    }
                    
                    eventoDiv.style.background = corFundo;
                    eventoDiv.style.position = 'relative';
                    eventoDiv.style.paddingRight = '50px';
                    
                    const conteudoDiv = document.createElement('div');
                    conteudoDiv.innerHTML = `
                        <strong style="font-size: 11px;">${icone} ${evento.titulo}</strong>
                        ${evento.recorrencia ? '<span style="font-size: 10px; margin-left: 4px;">üîÑ</span>' : ''}
                        <br><span style="font-size: 10px;">
                            ${evento.diaCompleto ? 'Dia todo' : evento.horarioInicio}
                            ${evento.local ? ` - üìç ${evento.local}` : ''}
                            ${evento.recorrencia ? ` - ${evento.recorrencia.tipo}` : ''}
                        </span>
                    `;
                    conteudoDiv.style.cursor = 'pointer';
                    conteudoDiv.onclick = function(e) {
                        e.stopPropagation();
                        editarEvento(evento);
                    };
                    
                    const botoesDiv = document.createElement('div');
                    botoesDiv.style.cssText = 'position: absolute; top: 4px; right: 4px; display: flex; gap: 4px;';
                    botoesDiv.innerHTML = `
                        <span class="edit-btn" onclick="event.stopPropagation(); editarEvento(${JSON.stringify(evento).replace(/"/g, '&quot;')})" 
                              style="cursor: pointer; color: #3b82f6; font-size: 14px;" title="Editar evento">‚úèÔ∏è</span>
                        <span class="delete-btn" onclick="event.stopPropagation(); deletarEvento(${evento.id})" 
                              style="cursor: pointer; color: #ef4444; font-size: 14px;" title="Excluir evento">√ó</span>
                    `;
                    
                    eventoDiv.appendChild(conteudoDiv);
                    eventoDiv.appendChild(botoesDiv);
                    
                    eventoDiv.title = `${evento.titulo}
${evento.descricao ? evento.descricao : ''}
${evento.recorrencia ? `üîÑ Recorr√™ncia: ${evento.recorrencia.tipo}` : ''}
${evento.pessoas && evento.pessoas.length > 1 ? `üë• ${evento.pessoas.length} pessoas` : ''}

üí° Clique no evento ou ‚úèÔ∏è para editar
    Clique no √ó para excluir`;
                    
                    eventoDiv.onmouseover = function() {
                        this.style.transform = 'translateY(-1px)';
                        this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                    };
                    eventoDiv.onmouseout = function() {
                        this.style.transform = 'none';
                        this.style.boxShadow = 'none';
                    };
                    
                    diaDiv.appendChild(eventoDiv);
                });
                
                container.appendChild(diaDiv);
            });
        }
        
        function renderizarResumoTarefasCompacto(atividade) {
            if (!atividade.tarefas || atividade.tarefas.length === 0) {
                return '';
            }
            
            const totalTarefas = atividade.tarefas.length;
            const tarefasConcluidas = atividade.tarefas.filter(t => t.status === 'concluida').length;
            
            return `
                <div style="margin-top: 8px; font-size: 11px; color: #6b7280;">
                    üìã ${tarefasConcluidas}/${totalTarefas} tarefas conclu√≠das
                </div>
            `;
        }
        
        function carregarObservacoes(nome) {
            const observacoes = dados.agendas[nome]?.observacoes || '';
            document.getElementById('observacoesPessoais').value = observacoes;
        }
        
        function salvarObservacoes() {
            const nome = estadoSistema.pessoaAtual;
            if (!dados.agendas[nome]) {
                dados.agendas[nome] = {};
            }
            dados.agendas[nome].observacoes = document.getElementById('observacoesPessoais').value;
            salvarDados();
        }
        
        // Outras fun√ß√µes auxiliares
        function atualizarBreadcrumb(path) {
            const breadcrumb = document.getElementById('breadcrumb');
            const breadcrumbPath = document.getElementById('breadcrumbPath');
            
            breadcrumb.classList.remove('hidden');
            
            const parts = path.split(' > ');
            const links = parts.map((part, index) => {
                if (index === 0) {
                    return `<a onclick="voltarDashboard()">Dashboard</a>`;
                } else if (index === parts.length - 1) {
                    return part;
                } else {
                    return `<a onclick="mostrarArea('${estadoSistema.areaAtual}')">${part}</a>`;
                }
            });
            
            breadcrumbPath.innerHTML = links.join(' > ');
        }
        
        function adicionarHistorico(tipo, dadosHistorico) {
            if (!dados.historico) {
                dados.historico = [];
            }
            
            dados.historico.push({
                tipo: tipo,
                dados: dadosHistorico,
                usuario: estadoSistema.pessoaAtual || 'Sistema',
                timestamp: new Date().toISOString()
            });
            
            if (dados.historico.length > 100) {
                dados.historico = dados.historico.slice(-100);
            }
        }
        
        // Fun√ß√µes de tarefas pessoais
        function mostrarNovaTarefa() {
            document.getElementById('modalTarefa').classList.add('active');
        }
        
        function alternarTipoAgendamento() {
            const tipo = document.getElementById('tarefaTipo').value;
            if (tipo === 'semanal') {
                document.getElementById('grupoDiaSemana').classList.remove('hidden');
                document.getElementById('grupoData').classList.add('hidden');
            } else {
                document.getElementById('grupoDiaSemana').classList.add('hidden');
                document.getElementById('grupoData').classList.remove('hidden');
            }
        }
        
        function salvarTarefa() {
            const nome = estadoSistema.pessoaAtual;
            const tipo = document.getElementById('tarefaTipo').value;
            const descricao = document.getElementById('tarefaDescricao').value;
            const horario = document.getElementById('tarefaHorario').value;
            const recorrencia = document.getElementById('tarefaRecorrencia').value;
            const mostrarNoCalendario = document.getElementById('tarefaCalendario').checked;
            
            if (!validarFormulario([
                {id: 'tarefaDescricao'},
                {id: 'tarefaHorario'}
            ])) {
                mostrarNotificacao('Preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }
            
            if (tipo === 'data') {
                if (!document.getElementById('tarefaDataEspecifica').value) {
                    document.getElementById('tarefaDataEspecifica').classList.add('input-error');
                    document.getElementById('tarefaDataError').classList.remove('hidden');
                    mostrarNotificacao('Selecione uma data!', 'error');
                    return;
                }
            }
            
            const tarefaBase = {
                id: Date.now(),
                descricao: `${descricao} - ${horario}`,
                recorrencia: recorrencia,
                mostrarNoCalendario: mostrarNoCalendario
            };
            
            if (!dados.agendas[nome]) {
                dados.agendas[nome] = {};
            }
            
            if (tipo === 'semanal') {
                const dia = document.getElementById('tarefaDia').value;
                
                if (!dados.agendas[nome][dia]) {
                    dados.agendas[nome][dia] = [];
                }
                
                dados.agendas[nome][dia].push(tarefaBase);
            } else {
                const dataEspecifica = document.getElementById('tarefaDataEspecifica').value;
                
                const evento = {
                    id: Date.now(),
                    data: dataEspecifica,
                    horarioInicio: horario,
                    titulo: descricao,
                    tipo: 'outro',
                    pessoas: [nome],
                    origem: 'tarefa_pessoal'
                };
                dados.eventos.push(evento);
            }
            
            salvarDados();
            fecharModal('modalTarefa');
            renderizarAgendaSemana(nome);
            gerarCalendario();
            
            // ‚úÖ SINCRONIZA√á√ÉO AUTOM√ÅTICA ADICIONADA
            atualizarTodasAgendasPessoais();
            
            mostrarNotificacao('Tarefa salva com sucesso!');
        }

        function deletarTarefa(nome, dia, tarefaId) {
            if (confirm('Deseja realmente excluir esta tarefa?')) {
                dados.agendas[nome][dia] = dados.agendas[nome][dia].filter(t => t.id != tarefaId);
                salvarDados();
                renderizarAgendaSemana(nome);
                
                // ‚úÖ SINCRONIZA√á√ÉO AUTOM√ÅTICA ADICIONADA
                atualizarTodasAgendasPessoais();
                
                mostrarNotificacao('Tarefa exclu√≠da!');
            }
        }
        
        // Fun√ß√µes de status pessoal
        function mostrarMarcarStatus() {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('statusData').value = hoje;
            document.getElementById('modalStatus').classList.add('active');
        }
        
        function salvarStatus() {
            const nome = estadoSistema.pessoaAtual;
            const data = document.getElementById('statusData').value;
            const tipo = document.getElementById('statusTipo').value;
            const observacao = document.getElementById('statusObservacao').value;
            
            if (!data) {
                document.getElementById('statusData').classList.add('input-error');
                document.getElementById('statusDataError').classList.remove('hidden');
                return;
            }
            
            if (!dados.statusPessoal) {
                dados.statusPessoal = {};
            }
            if (!dados.statusPessoal[nome]) {
                dados.statusPessoal[nome] = {};
            }
            
            if (tipo === 'presente') {
                delete dados.statusPessoal[nome][data];
            } else {
                dados.statusPessoal[nome][data] = {
                    tipo: tipo,
                    observacao: observacao
                };
            }
            
            salvarDados();
            fecharModal('modalStatus');
            renderizarAgendaSemana(nome);
            mostrarNotificacao('Status do dia salvo com sucesso!');
        }
        
        // Fun√ß√µes de feriados
        function mostrarMarcarFeriado() {
            document.getElementById('modalFeriado').classList.add('active');
            listarFeriados();
        }
        
        function salvarFeriado() {
            const data = document.getElementById('feriadoData').value;
            const nome = document.getElementById('feriadoNome').value;
            
            if (!validarFormulario([
                {id: 'feriadoData'},
                {id: 'feriadoNome'}
            ])) {
                mostrarNotificacao('Preencha todos os campos!', 'error');
                return;
            }
            
            if (!dados.feriados) {
                dados.feriados = {};
            }
            
            dados.feriados[data] = nome;
            
            salvarDados();
            document.getElementById('feriadoData').value = '';
            document.getElementById('feriadoNome').value = '';
            listarFeriados();
            gerarCalendario();
            mostrarNotificacao('Feriado cadastrado com sucesso!');
        }
        
        function listarFeriados() {
            const lista = document.getElementById('listaFeriados');
            lista.innerHTML = '';
            
            if (dados.feriados && Object.keys(dados.feriados).length > 0) {
                Object.entries(dados.feriados)
                    .sort((a, b) => new Date(a[0]) - new Date(b[0]))
                    .forEach(([data, nome]) => {
                        const div = document.createElement('div');
                        div.style.cssText = 'padding: 8px; background: #fef3c7; margin-bottom: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;';
                        div.innerHTML = `
                            <span>${formatarData(data)} - ${nome}</span>
                            <span class="delete-btn" onclick="deletarFeriado('${data}')">√ó</span>
                        `;
                        lista.appendChild(div);
                    });
            } else {
                lista.innerHTML = '<p style="text-align: center; color: #6b7280;">Nenhum feriado cadastrado</p>';
            }
        }
        
        function deletarFeriado(data) {
            if (confirm('Deseja remover este feriado?')) {
                delete dados.feriados[data];
                salvarDados();
                listarFeriados();
                gerarCalendario();
                mostrarNotificacao('Feriado removido!');
            }
        }
        
        // Fun√ß√µes de importa√ß√£o/exporta√ß√£o
        function exportarDados() {
            const dataExport = {
                ...dados,
                exportadoEm: new Date().toISOString(),
                versao: VERSAO_SISTEMA
            };
            
            const blob = new Blob([JSON.stringify(dataExport, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-gestao-obra-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            mostrarNotificacao('Dados exportados com sucesso!');
        }
        
        function mostrarImportar() {
            document.getElementById('modalImportar').classList.add('active');
        }
        
        function importarDados() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                mostrarNotificacao('Selecione um arquivo!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.areas && importedData.eventos) {
                        const backup = {...dados};
                        
                        try {
                            dados = {
                                versao: importedData.versao || VERSAO_DB,
                                areas: importedData.areas,
                                eventos: importedData.eventos,
                                agendas: importedData.agendas || {},
                                feriados: importedData.feriados || {},
                                statusPessoal: importedData.statusPessoal || {},
                                historico: importedData.historico || [],
                                ultimaAtualizacao: new Date().toISOString()
                            };
                            
                            salvarDados();
                            fecharModal('modalImportar');
                            renderizarDashboard();
                            mostrarNotificacao('Dados importados com sucesso!');
                        } catch (erro) {
                            dados = backup;
                            throw erro;
                        }
                    } else {
                        mostrarNotificacao('Arquivo inv√°lido!', 'error');
                    }
                } catch (error) {
                    console.error('Erro ao importar:', error);
                    mostrarNotificacao('Erro ao importar arquivo!', 'error');
                }
            };
            reader.readAsText(file);
        }
        
        // Fun√ß√µes de busca
        let timeoutBusca = null;
        
        function buscarGlobalDebounced() {
            clearTimeout(timeoutBusca);
            timeoutBusca = setTimeout(buscarGlobal, 300);
        }
        
        function buscarGlobal() {
            const termo = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!termo) {
                renderizarDashboard();
                return;
            }
            
            let resultados = [];
            
            Object.entries(dados.areas).forEach(([areaKey, area]) => {
                area.atividades.forEach(atividade => {
                    const match = atividade.nome.toLowerCase().includes(termo) ||
                                 atividade.responsaveis.some(r => r.toLowerCase().includes(termo));
                    
                    if (match) {
                        resultados.push({
                            tipo: 'atividade',
                            area: area.nome,
                            areaKey: areaKey,
                            atividade: atividade
                        });
                    }
                });
            });
            
            dados.eventos.forEach(evento => {
                if (evento.titulo.toLowerCase().includes(termo) ||
                    (evento.pessoas && evento.pessoas.some(p => p.toLowerCase().includes(termo)))) {
                    resultados.push({
                        tipo: 'evento',
                        evento: evento
                    });
                }
            });
            
            const pessoasEncontradas = new Set();
            Object.values(dados.areas).forEach(area => {
                area.equipe.forEach(membro => {
                    if (membro.nome.toLowerCase().includes(termo) || 
                        membro.cargo.toLowerCase().includes(termo)) {
                        pessoasEncontradas.add({
                            nome: membro.nome,
                            cargo: membro.cargo,
                            area: area.nome
                        });
                    }
                });
            });
            
            pessoasEncontradas.forEach(pessoa => {
                resultados.push({
                    tipo: 'pessoa',
                    pessoa: pessoa
                });
            });
            
            mostrarResultadosBusca(resultados, termo);
        }
        
        function mostrarResultadosBusca(resultados, termo) {
            const grid = document.getElementById('areasGrid');
            grid.innerHTML = '';
            
            const cardResultados = document.createElement('div');
            cardResultados.className = 'card';
            cardResultados.style.gridColumn = 'span 3';
            
            cardResultados.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üîç Resultados da busca: "${termo}"</h3>
                    <button class="btn btn-secondary btn-sm" onclick="limparBusca()">Limpar busca</button>
                </div>
                <p style="color: #6b7280; margin-bottom: 16px;">${resultados.length} resultados encontrados</p>
            `;
            
            if (resultados.length === 0) {
                cardResultados.innerHTML += `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p style="font-size: 48px; margin-bottom: 16px;">üîç</p>
                        <p>Nenhum resultado encontrado para "${termo}"</p>
                    </div>
                `;
            } else {
                const atividades = resultados.filter(r => r.tipo === 'atividade');
                const eventos = resultados.filter(r => r.tipo === 'evento');
                const pessoas = resultados.filter(r => r.tipo === 'pessoa');
                
                if (atividades.length > 0) {
                    cardResultados.innerHTML += '<h4 style="margin-top: 20px; margin-bottom: 12px;">üìã Atividades</h4>';
                    atividades.forEach(res => {
                        const diasRestantes = calcularDiasRestantes(res.atividade.prazo);
                        cardResultados.innerHTML += `
                            <div style="padding: 12px; border: 1px solid #e5e7eb; margin-bottom: 8px; border-radius: 8px; cursor: pointer;" 
                                 onclick="abrirAreaAtividade('${res.areaKey}', ${res.atividade.id})">
                                <strong>${res.atividade.nome}</strong>
                                <span class="status-indicator status-${res.atividade.status}" style="float: right;"></span>
                                <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
                                    ${res.area} | Respons√°veis: ${res.atividade.responsaveis.join(', ')}
                                    <br>Prazo: ${formatarData(res.atividade.prazo)} (${diasRestantes} dias)
                                </div>
                            </div>
                        `;
                    });
                }
                
                if (eventos.length > 0) {
                    cardResultados.innerHTML += '<h4 style="margin-top: 20px; margin-bottom: 12px;">üìÖ Eventos</h4>';
                    eventos.forEach(res => {
                        cardResultados.innerHTML += `
                            <div style="padding: 12px; border: 1px solid #e5e7eb; margin-bottom: 8px; border-radius: 8px;">
                                <strong>${res.evento.titulo}</strong>
                                <span class="evento evento-${res.evento.tipo}" style="float: right; padding: 4px 8px;">
                                    ${res.evento.tipo}
                                </span>
                                <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
                                    ${formatarData(res.evento.data)} ${res.evento.diaCompleto ? '(Dia todo)' : `√†s ${res.evento.horarioInicio}`} | 
                                    ${res.evento.pessoas.length} pessoa(s)
                                </div>
                            </div>
                        `;
                    });
                }
                
                if (pessoas.length > 0) {
                    cardResultados.innerHTML += '<h4 style="margin-top: 20px; margin-bottom: 12px;">üë• Pessoas</h4>';
                    pessoas.forEach(res => {
                        cardResultados.innerHTML += `
                            <div style="padding: 12px; border: 1px solid #e5e7eb; margin-bottom: 8px; border-radius: 8px;">
                                <strong>${res.pessoa.nome}</strong>
                                <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
                                    ${res.pessoa.cargo} | ${res.pessoa.area}
                                </div>
                            </div>
                        `;
                    });
                }
            }
            
            grid.appendChild(cardResultados);
        }
        
        function limparBusca() {
            document.getElementById('searchInput').value = '';
            renderizarDashboard();
        }
        
        function abrirAreaAtividade(areaKey, atividadeId) {
            mostrarArea(areaKey);
            setTimeout(() => {
                const elemento = document.querySelector(`[data-atividade-id="${atividadeId}"]`);
                if (elemento) {
                    elemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    elemento.style.border = '2px solid #3b82f6';
                    setTimeout(() => {
                        elemento.style.border = '1px solid #e5e7eb';
                    }, 2000);
                }
            }, 100);
        }
        
        function filtrarStatus(status, elemento) {
            estadoSistema.filtroAtual = status;
            
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.classList.remove('active');
            });
            elemento.classList.add('active');
            
            if (estadoSistema.areaAtual) {
                renderizarAtividades(dados.areas[estadoSistema.areaAtual]);
            }
        }
        
        // Fun√ß√µes auxiliares do sistema de responsabilidades
        function gerenciarTarefasResponsabilidade(atividadeId, areaKey) {
            const areaAnterior = estadoSistema.areaAtual;
            estadoSistema.areaAtual = areaKey;
            
            const area = dados.areas[areaKey];
            const atividade = area.atividades.find(a => a.id === atividadeId);
            
            if (atividade) {
                mostrarModalTarefas(atividade);
            }
        }
        
        function mudarStatusResponsabilidade(atividadeId, areaKey, novoStatus) {
            const area = dados.areas[areaKey];
            const atividade = area.atividades.find(a => a.id === atividadeId);
            if (atividade) {
                atividade.status = novoStatus;
                salvarDados();
                renderizarResponsabilidades(estadoSistema.pessoaAtual);
                mostrarNotificacao('Status atualizado!');
            }
        }
        
        function editarResponsabilidade(atividadeId, areaKey) {
            const areaTemp = estadoSistema.areaAtual;
            estadoSistema.areaAtual = areaKey;
            editarAtividade(atividadeId);
        }
        
        function removerResponsabilidade(atividadeId, areaKey, nomePessoa) {
            const area = dados.areas[areaKey];
            const atividade = area.atividades.find(a => a.id === atividadeId);
            
            if (atividade && atividade.responsaveis.length > 1) {
                if (confirm('Deseja remover-se desta atividade?')) {
                    atividade.responsaveis = atividade.responsaveis.filter(r => r !== nomePessoa);
                    salvarDados();
                    renderizarResponsabilidades(nomePessoa);
                    mostrarNotificacao('Voc√™ foi removido(a) da atividade!');
                }
            } else {
                mostrarNotificacao('N√£o √© poss√≠vel remover o √∫nico respons√°vel!', 'error');
            }
        }
        
        function mostrarAdicionarResponsabilidade() {
            mostrarNotificacao('Fun√ß√£o em desenvolvimento...');
        }
        
        function validarFormulario(campos) {
            let valido = true;
            
            campos.forEach(campo => {
                const elemento = document.getElementById(campo.id);
                const erro = document.getElementById(campo.id + 'Error');
                
                if (!elemento.value || (campo.tipo === 'select' && elemento.selectedOptions.length === 0)) {
                    elemento.classList.add('input-error');
                    if (erro) erro.classList.remove('hidden');
                    valido = false;
                } else {
                    elemento.classList.remove('input-error');
                    if (erro) erro.classList.add('hidden');
                }
            });
            
            return valido;
        }
        
        function fecharModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            
            const modal = document.getElementById(modalId);
            modal.querySelectorAll('input[type="text"], input[type="date"], input[type="time"], input[type="number"], textarea').forEach(input => {
                input.value = '';
                input.classList.remove('input-error');
            });
            modal.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
                select.classList.remove('input-error');
            });
            modal.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            modal.querySelectorAll('.error-message').forEach(error => {
                error.classList.add('hidden');
            });
            
            if (estadoSistema.editandoAtividade) {
                pararEditando('atividade', estadoSistema.editandoAtividade);
            }
            if (estadoSistema.editandoEvento) {
                pararEditando('evento', estadoSistema.editandoEvento);
            }
            
            estadoSistema.editandoAtividade = null;
            estadoSistema.editandoEvento = null;
            estadoSistema.editandoTarefa = null;
            estadoSistema.pessoasSelecionadas.clear();
            estadoSistema.tarefasVinculadas.clear();
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log(`üèóÔ∏è Sistema de Gest√£o Firebase v${VERSAO_SISTEMA} iniciado`);
            console.log('üî• VERS√ÉO 5.1 - SISTEMA COMPLETO E OTIMIZADO:');
            console.log('‚úÖ Edi√ß√£o completa de tarefas funcionando');
            console.log('‚úÖ Valida√ß√£o de prazos - bloqueia cria√ß√£o no passado');
            console.log('‚úÖ Progresso autom√°tico calculado pelas tarefas');
            console.log('‚úÖ Alertas autom√°ticos para prazos vencendo');
            console.log('‚úÖ Monitoramento 24/7 dos status das atividades');
            console.log('‚úÖ Verifica√ß√£o autom√°tica a cada hora');
            console.log('‚úÖ Beto corrigido como Arquiteto');
            console.log('‚úÖ Credenciais Firebase configuradas');
            console.log('‚úÖ Sincroniza√ß√£o autom√°tica agenda ‚Üî calend√°rio');
            console.log('‚úÖ Sistema de integridade e otimiza√ß√£o');
            console.log('‚úÖ Logs detalhados para monitoramento');
            console.log('üöÄ TODAS AS FUNCIONALIDADES IMPLEMENTADAS!');
            
            const eventoData = document.getElementById('eventoData');
            if (eventoData) {
                eventoData.addEventListener('change', function() {
                    const recorrente = document.getElementById('eventoRecorrente').checked;
                    const tipoRecorrencia = document.getElementById('recorrenciaTipo').value;
                    
                    if (recorrente && (tipoRecorrencia === 'semanal' || tipoRecorrencia === 'personalizada')) {
                        marcarDiaSemanaCorrespondente(this.value);
                    }
                });
            }
            
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    salvarDados();
                    mostrarNotificacao('Dados salvos!');
                }
                
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        fecharModal(modal.id);
                    });
                }
                
                // Atalho para verificar integridade (Ctrl+Shift+I)
                if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                    e.preventDefault();
                    verificarIntegridadeSistema();
                }
            });
        });
        
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    fecharModal(this.id);
                }
            });
        });
        
        window.addEventListener('beforeunload', function(e) {
            if (usuarioAtual) {
                salvarDados();
            }
        });
    </script>
</body>
</html> 
