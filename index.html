<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão Completo - Obra 292 (Firebase v5.1) - CORRIGIDO</title>
    
    <style>
    /* CSS Básico - Incorporado para garantir funcionamento */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f8fafc;
        color: #334155;
    }
    
    .hidden { display: none !important; }
    
    .login-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .login-container > div {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        width: 100%;
        max-width: 400px;
    }
    
    .login-container h2 {
        text-align: center;
        margin-bottom: 8px;
        color: #1e293b;
        font-size: 24px;
    }
    
    .form-group {
        margin-bottom: 16px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #374151;
    }
    
    .form-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s;
    }
    
    .form-group input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-group input.input-error {
        border-color: #ef4444;
        background: #fef2f2;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
        text-align: center;
    }
    
    .btn-primary {
        background: #3b82f6;
        color: white;
    }
    
    .btn-primary:hover {
        background: #2563eb;
    }
    
    .btn-primary:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .header {
        background: white;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .calendario {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .dia-header {
        background: #374151;
        color: white;
        padding: 12px;
        text-align: center;
        font-weight: 600;
        font-size: 14px;
    }
    
    .dia {
        background: white;
        min-height: 120px;
        padding: 8px;
        position: relative;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .dia:hover {
        background: #f8fafc;
    }
    
    .dia.hoje {
        background: #dbeafe;
    }
    
    .dia.outro-mes {
        background: #f3f4f6;
        color: #9ca3af;
    }
    
    .dia-numero {
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .evento {
        background: #3b82f6;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        margin-bottom: 2px;
        cursor: pointer;
    }
    
    .evento-reuniao { background: #3b82f6; }
    .evento-entrega { background: #10b981; }
    .evento-prazo { background: #ef4444; }
    .evento-marco { background: #8b5cf6; }
    .evento-outro { background: #6b7280; }
    
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1000;
        transform: translateX(400px);
        transition: transform 0.3s;
    }
    
    .notification.show {
        transform: translateX(0);
    }
    
    .notification.error { background: #ef4444; }
    .notification.warning { background: #f59e0b; }
    .notification.info { background: #3b82f6; }
    
    .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .resumo-numero {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
    }
    
    .progress-bar {
        width: 100%;
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 8px;
    }
    
    .progress-fill {
        height: 100%;
        transition: width 0.3s;
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }
    
    .btn-secondary {
        background: #6b7280;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #4b5563;
    }
    
    .btn-success {
        background: #10b981;
        color: white;
    }
    
    .btn-warning {
        background: #f59e0b;
        color: white;
    }
    
    .btn-danger {
        background: #ef4444;
        color: white;
    }
    
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
    }
    
    code {
        background: #f1f5f9;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        color: #1e293b;
    }
        .header {
            flex-direction: column;
            text-align: center;
            gap: 16px;
        }
        
        .container {
            padding: 12px;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .dia {
            min-height: 80px;
            padding: 4px;
        }
    }
    </style>
</head>
<body>
    <!-- Sistema de Notificações -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>
    
    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container">
        <div>
            <h2>🏗️ Sistema de Gestão</h2>
            <p style="text-align: center; color: #6b7280; margin-bottom: 24px;">Obra 292 - Museu Nacional</p>
            
            <!-- Credenciais de Demo -->
            <div style="background: #dbeafe; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 13px;">
                <strong>🔧 Acesso Demo:</strong><br>
                Email: <code>demo@sistema.com</code><br>
                Senha: <code>123456</code>
            </div>
            
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="demo@sistema.com">
            </div>
            
            <div class="form-group">
                <label>Senha</label>
                <input type="password" id="loginPassword" placeholder="123456">
            </div>
            
            <button class="btn btn-primary" style="width: 100%;" onclick="fazerLogin()">
                Entrar
            </button>
            
            <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="loginDemo()">
                🚀 Login Demo Rápido
            </button>
            
            <div style="margin-top: 16px; text-align: center;">
                <a href="#" onclick="mostrarRegistro()" style="color: #3b82f6; text-decoration: none;">
                    Não tem conta? Registre-se
                </a>
            </div>
            
            <div style="margin-top: 16px; text-align: center; font-size: 12px; color: #6b7280;">
                Sistema funcionando com Firebase + Modo Demo
            </div>
        </div>
    </div>
    
    <!-- Container Principal -->
    <div class="container hidden" id="mainContainer">
        <div class="header">
            <div>
                <h1>Sistema de Gestão Colaborativo</h1>
                <p>Obra 292 - Museu Nacional</p>
                <p style="font-size: 14px; color: #6b7280;">
                    Sistema v5.1 Firebase - CORRIGIDO 🚀
                    <span id="usuarioInfo" style="margin-left: 16px; font-weight: bold;"></span>
                </p>
            </div>
            <div style="text-align: right;">
                <p id="dataAtual" style="color: #6b7280;"></p>
                <p style="font-weight: bold;">
                    <span id="mesAno">Julho 2025</span>
                </p>
                <div style="margin-top: 8px;">
                    <button class="btn btn-danger btn-sm" onclick="fazerLogout()">
                        🚪 Sair
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Executivo -->
        <div id="dashboardExecutivo">
            <!-- Estatísticas Rápidas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="resumo-numero" style="color: #10b981;" id="statEmDia">0</div>
                    <div>Em Dia</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressEmDia" style="background: #10b981;"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="resumo-numero" style="color: #f59e0b;" id="statAtencao">0</div>
                    <div>Atenção</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressAtencao" style="background: #f59e0b;"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="resumo-numero" style="color: #ef4444;" id="statAtraso">0</div>
                    <div>Atraso</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressAtraso" style="background: #ef4444;"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="resumo-numero" style="color: #8b5cf6;" id="statEventos">0</div>
                    <div>Eventos no Mês</div>
                </div>
            </div>
            
            <!-- Calendário -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>📅 Calendário da Equipe</h3>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary btn-sm" onclick="mudarMes(-1)">◀ Anterior</button>
                        <button class="btn btn-primary btn-sm" onclick="mostrarNovoEvento()">+ Novo Evento</button>
                        <button class="btn btn-secondary btn-sm" onclick="mudarMes(1)">Próximo ▶</button>
                    </div>
                </div>
                
                <div id="calendario" class="calendario"></div>
                
                <div style="margin-top: 16px; display: flex; gap: 16px; flex-wrap: wrap; font-size: 12px;">
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: #3b82f6; border-radius: 50%; margin-right: 4px;"></span>Reunião</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: #10b981; border-radius: 50%; margin-right: 4px;"></span>Entrega</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: #ef4444; border-radius: 50%; margin-right: 4px;"></span>Prazo</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: #8b5cf6; border-radius: 50%; margin-right: 4px;"></span>Marco</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: #6b7280; border-radius: 50%; margin-right: 4px;"></span>Outros</span>
                </div>
            </div>
            
            <!-- Status do Sistema -->
            <div class="card">
                <h3 style="margin-bottom: 16px;">📊 Status do Sistema</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div>
                        <strong>Estado:</strong> <span id="statusSistema">Inicializando...</span>
                    </div>
                    <div>
                        <strong>Usuário:</strong> <span id="statusUsuario">Não logado</span>
                    </div>
                    <div>
                        <strong>Dados:</strong> <span id="statusDados">Carregando...</span>
                    </div>
                    <div>
                        <strong>Calendário:</strong> <span id="statusCalendario">Inicializando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-auth-compat.js"></script>
    
    <script>
    // ========== CONFIGURAÇÃO FIREBASE ==========
    const firebaseConfig = {
        apiKey: "AIzaSyDeOl-TYP0FRU5k8UKE4k0PYO8m2uWDZRQ",
        authDomain: "sistema-gestao-obra.firebaseapp.com",
        databaseURL: "https://sistema-gestao-obra-default-rtdb.firebaseio.com",
        projectId: "sistema-gestao-obra",
        storageBucket: "sistema-gestao-obra.firebasestorage.app",
        messagingSenderId: "123164040934",
        appId: "1:123164040934:web:7b2e2e2e2e2e2e2e2e2e2e"
    };

    // Inicializar Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log('✅ Firebase inicializado');
    }

    // ========== VARIÁVEIS GLOBAIS ==========
    let usuarioAtual = null;
    let dados = null;
    let estadoSistema = {
        mesAtual: new Date().getMonth(),
        anoAtual: new Date().getFullYear(),
        areaAtual: null,
        pessoaAtual: null,
        filtroAtual: 'todos',
        editandoAtividade: null,
        editandoEvento: null,
        editandoTarefa: null,
        pessoasSelecionadas: new Set(),
        tarefasVinculadas: new Map(),
        versaoSistema: '5.1',
        usuarioEmail: null,
        usuarioNome: null,
        alertasPrazosExibidos: new Set(),
        online: true
    };

    // ========== SISTEMA DE NOTIFICAÇÕES ==========
    const Notifications = {
        sucesso: (mensagem) => mostrarNotificacao(mensagem, 'success'),
        erro: (mensagem) => mostrarNotificacao(mensagem, 'error'),
        atencao: (mensagem) => mostrarNotificacao(mensagem, 'warning'),
        info: (mensagem) => mostrarNotificacao(mensagem, 'info')
    };

    function mostrarNotificacao(mensagem, tipo = 'info') {
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');
        
        if (!notification || !notificationText) return;
        
        // Limpar classes anteriores
        notification.className = 'notification';
        
        // Adicionar classe do tipo
        if (tipo !== 'info') {
            notification.classList.add(tipo);
        }
        
        notificationText.textContent = mensagem;
        notification.classList.add('show');
        
        // Auto-remover após 3 segundos
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
        
        console.log(`📢 ${tipo.toUpperCase()}: ${mensagem}`);
    }

    // ========== FUNÇÕES DE AUTENTICAÇÃO ==========
    function fazerLogin() {
        const email = document.getElementById('loginEmail')?.value;
        const senha = document.getElementById('loginPassword')?.value;
        
        console.log('🔑 Tentativa de login para:', email);
        
        if (!email || !senha) {
            Notifications.erro('Preencha email e senha!');
            return;
        }
        
        if (!email.includes('@')) {
            Notifications.erro('Email inválido!');
            return;
        }
        
        if (senha.length < 6) {
            Notifications.erro('Senha deve ter pelo menos 6 caracteres!');
            return;
        }
        
        // Mostrar loading
        const botao = document.querySelector('#loginScreen .btn-primary');
        if (botao) {
            botao.disabled = true;
            botao.innerHTML = '<span class="loading"></span> Entrando...';
        }
        
        Notifications.info('Entrando...');
        
        // SISTEMA DE FALLBACK - Login temporário para desenvolvimento
        if (email === 'demo@sistema.com' && senha === '123456') {
            console.log('🔧 Usando login de demonstração');
            usuarioAtual = {
                uid: 'demo-user',
                email: email,
                displayName: 'Usuário Demo'
            };
            
            setTimeout(() => {
                Notifications.sucesso('🎉 Bem-vindo ao Sistema! (Modo Demonstração)');
                inicializarSistemaLogado();
                
                if (botao) {
                    botao.disabled = false;
                    botao.innerHTML = 'Entrar';
                }
            }, 1000);
            return;
        }
        
        // Login Firebase
        firebase.auth().signInWithEmailAndPassword(email, senha)
            .then((userCredential) => {
                usuarioAtual = userCredential.user;
                console.log('✅ Login realizado com sucesso:', usuarioAtual.email);
                
                Notifications.sucesso('Login realizado com sucesso!');
                inicializarSistemaLogado();
            })
            .catch((error) => {
                console.error('❌ Erro no login:', error);
                
                let mensagem = 'Erro ao fazer login';
                switch (error.code) {
                    case 'auth/user-not-found':
                        mensagem = 'Usuário não encontrado! Tente: demo@sistema.com / 123456';
                        break;
                    case 'auth/wrong-password':
                        mensagem = 'Senha incorreta! Tente: demo@sistema.com / 123456';
                        break;
                    case 'auth/invalid-email':
                        mensagem = 'Email inválido!';
                        break;
                    case 'auth/too-many-requests':
                        mensagem = 'Muitas tentativas. Tente novamente mais tarde.';
                        break;
                    case 'auth/api-key-not-valid':
                        mensagem = 'Problema na configuração. Use: demo@sistema.com / 123456';
                        break;
                    default:
                        mensagem = 'Erro na autenticação. Tente: demo@sistema.com / 123456';
                }
                
                Notifications.erro(mensagem);
            })
            .finally(() => {
                if (botao) {
                    botao.disabled = false;
                    botao.innerHTML = 'Entrar';
                }
            });
    }

    function mostrarRegistro() {
        Notifications.info('Função de registro em desenvolvimento...');
    }

    function loginDemo() {
        document.getElementById('loginEmail').value = 'demo@sistema.com';
        document.getElementById('loginPassword').value = '123456';
        fazerLogin();
    }

    function fazerLogout() {
        if (!confirm('Tem certeza que deseja sair?')) {
            return;
        }
        
        console.log('🚪 Fazendo logout...');
        
        firebase.auth().signOut()
            .then(() => {
                console.log('✅ Logout realizado com sucesso');
                usuarioAtual = null;
                
                // Mostrar tela de login
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainContainer').classList.add('hidden');
                
                // Limpar campos
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                
                Notifications.sucesso('Logout realizado com sucesso!');
            })
            .catch((error) => {
                console.error('❌ Erro ao fazer logout:', error);
                Notifications.erro('Erro ao sair!');
            });
    }

    // ========== SISTEMA DE DADOS ==========
    function inicializarDados() {
        console.log('🔧 Inicializando dados padrão do sistema...');
        
        return {
            versao: 5,
            areas: {
                documentacao: {
                    nome: "Documentação & Arquivo",
                    coordenador: "Renato Remiro",
                    cor: "#8b5cf6",
                    equipe: [
                        {nome: "Renato", cargo: "Coordenador"},
                        {nome: "Bruna", cargo: "Arquiteta Trainee"},
                        {nome: "Juliana A.", cargo: "Estagiária de Arquitetura"},
                        {nome: "Lara", cargo: "Arquiteta Trainee"}
                    ],
                    atividades: [
                        {
                            id: 1, 
                            nome: "As Built", 
                            status: "verde", 
                            prazo: "2025-07-18", 
                            responsaveis: ["Renato", "Bruna"], 
                            progresso: 0, 
                            dataAdicionado: new Date().toISOString(),
                            tarefas: []
                        },
                        {
                            id: 2, 
                            nome: "Relatório Fotográfico", 
                            status: "amarelo", 
                            prazo: "2025-07-12", 
                            responsaveis: ["Bruna"], 
                            progresso: 0, 
                            dataAdicionado: new Date().toISOString(),
                            tarefas: []
                        },
                        {
                            id: 3, 
                            nome: "Manual de Conservação", 
                            status: "verde", 
                            prazo: "2025-07-25", 
                            responsaveis: ["Renato"], 
                            progresso: 0, 
                            dataAdicionado: new Date().toISOString(),
                            tarefas: []
                        }
                    ]
                },
                planejamento: {
                    nome: "Planejamento & Controle de Obra",
                    coordenador: "Isabella Rocha (Coord. Geral)",
                    cor: "#06b6d4",
                    equipe: [
                        {nome: "Isabella", cargo: "Coordenadora Geral"},
                        {nome: "Lara", cargo: "Arquiteta Trainee"},
                        {nome: "Eduardo", cargo: "Engenheiro Civil"},
                        {nome: "Beto", cargo: "Arquiteto"}
                    ],
                    atividades: [
                        {
                            id: 7, 
                            nome: "Cronograma Longo Prazo (CLP)", 
                            status: "verde", 
                            prazo: "2025-07-10", 
                            responsaveis: ["Lara", "Isabella"], 
                            progresso: 0, 
                            dataAdicionado: new Date().toISOString(), 
                            tarefas: []
                        },
                        {
                            id: 8, 
                            nome: "PPCO", 
                            status: "verde", 
                            prazo: "2025-07-31", 
                            responsaveis: ["Lara", "Isabella"], 
                            progresso: 0, 
                            dataAdicionado: new Date().toISOString(), 
                            tarefas: []
                        }
                    ]
                }
            },
            eventos: [
                {
                    id: 1, 
                    titulo: "Reunião semanal de planejamento", 
                    tipo: "reuniao",
                    data: "2025-07-01",
                    horarioInicio: "09:00",
                    horarioFim: "11:00",
                    diaCompleto: false,
                    pessoas: ["Isabella", "Lara", "Eduardo", "Beto"],
                    local: "Sala de reunião principal",
                    descricao: "Revisão do cronograma e distribuição de tarefas da semana"
                },
                {
                    id: 2, 
                    titulo: "Entrega Relatório Fotográfico", 
                    tipo: "entrega",
                    data: "2025-07-15",
                    horarioInicio: "17:00",
                    diaCompleto: false,
                    pessoas: ["Bruna"],
                    descricao: "Entrega mensal do relatório com registro fotográfico do progresso da obra"
                }
            ],
            agendas: {},
            feriados: {},
            statusPessoal: {},
            historico: [],
            configuracoes: {
                autoSave: true,
                intervaloVerificacao: 3600000,
                limiteHistorico: 100
            },
            ultimaAtualizacao: new Date().toISOString(),
            criadoEm: new Date().toISOString(),
            ultimoUsuario: null
        };
    }

    async function carregarDados() {
        console.log('📦 Carregando dados...');
        
        try {
            // Se for usuário demo, usar dados locais
            if (usuarioAtual?.email === 'demo@sistema.com') {
                dados = inicializarDados();
                console.log('📦 Dados demo carregados localmente');
                atualizarStatusSistema('statusDados', 'Dados Demo', 'success');
                return true;
            }
            
            // Tentar carregar do Firebase
            const snapshot = await firebase.database().ref('dados').once('value');
            const dadosServidor = snapshot.val();
            
            if (dadosServidor) {
                dados = dadosServidor;
                console.log('📦 Dados carregados do Firebase');
                atualizarStatusSistema('statusDados', 'Carregados do Firebase', 'success');
                return true;
            } else {
                console.log('🔧 Nenhum dado encontrado - inicializando dados padrão');
                dados = inicializarDados();
                
                // Salvar dados iniciais
                await firebase.database().ref('dados').set(dados);
                console.log('💾 Dados padrão salvos no Firebase');
                atualizarStatusSistema('statusDados', 'Inicializados', 'success');
                return true;
            }
        } catch (error) {
            console.error('❌ Erro ao carregar dados:', error);
            dados = inicializarDados();
            atualizarStatusSistema('statusDados', 'Modo Offline', 'success');
            return true; // Retorna true mesmo em erro para continuar funcionando
        }
    }

    // ========== SISTEMA DE CALENDÁRIO ==========
    const MESES = [
        'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];

    const DIAS_SEMANA = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];

    function gerarCalendario() {
        console.log('📅 Gerando calendário...');
        
        const calendario = document.getElementById('calendario');
        if (!calendario) {
            console.error('❌ Elemento calendário não encontrado!');
            return false;
        }
        
        calendario.innerHTML = '';
        
        // Criar headers dos dias da semana
        DIAS_SEMANA.forEach(dia => {
            const header = document.createElement('div');
            header.className = 'dia-header';
            header.textContent = dia;
            calendario.appendChild(header);
        });
        
        const primeiroDia = new Date(estadoSistema.anoAtual, estadoSistema.mesAtual, 1);
        const ultimoDia = new Date(estadoSistema.anoAtual, estadoSistema.mesAtual + 1, 0);
        const primeiroDiaSemana = primeiroDia.getDay();
        
        // Células vazias antes do primeiro dia
        for (let i = 0; i < primeiroDiaSemana; i++) {
            const diaVazio = document.createElement('div');
            diaVazio.className = 'dia outro-mes';
            calendario.appendChild(diaVazio);
        }
        
        // Gerar dias do mês
        for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
            const diaDiv = criarDiaCalendario(dia);
            calendario.appendChild(diaDiv);
        }
        
        // Atualizar título do mês
        const mesAno = document.getElementById('mesAno');
        if (mesAno) {
            mesAno.textContent = `${MESES[estadoSistema.mesAtual]} ${estadoSistema.anoAtual}`;
        }
        
        atualizarStatusSistema('statusCalendario', 'Funcionando', 'success');
        console.log('✅ Calendário gerado com sucesso');
        return true;
    }

    function criarDiaCalendario(dia) {
        const diaDiv = document.createElement('div');
        diaDiv.className = 'dia';
        
        const dataCompleta = `${estadoSistema.anoAtual}-${String(estadoSistema.mesAtual + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
        
        // Verificar se é hoje
        const hoje = new Date();
        if (hoje.getFullYear() === estadoSistema.anoAtual && 
            hoje.getMonth() === estadoSistema.mesAtual && 
            hoje.getDate() === dia) {
            diaDiv.classList.add('hoje');
        }
        
        // Criar número do dia
        const numeroDiv = document.createElement('div');
        numeroDiv.className = 'dia-numero';
        numeroDiv.textContent = dia;
        diaDiv.appendChild(numeroDiv);
        
        // Obter e renderizar eventos do dia
        const eventosDia = obterEventosDoDia(dataCompleta);
        
        eventosDia.forEach(evento => {
            const eventoDiv = document.createElement('div');
            eventoDiv.className = `evento evento-${evento.tipo}`;
            eventoDiv.textContent = evento.titulo;
            eventoDiv.title = `${evento.titulo}\n${evento.descricao || ''}`;
            diaDiv.appendChild(eventoDiv);
        });
        
        // Event listener para criar novo evento
        diaDiv.onclick = (e) => {
            if (e.target === diaDiv || e.target.classList.contains('dia-numero')) {
                mostrarNovoEvento(dataCompleta);
            }
        };
        
        return diaDiv;
    }

    function obterEventosDoDia(data) {
        if (!dados?.eventos) return [];
        
        return dados.eventos.filter(evento => evento.data === data);
    }

    function mudarMes(direcao) {
        estadoSistema.mesAtual += direcao;
        if (estadoSistema.mesAtual < 0) {
            estadoSistema.mesAtual = 11;
            estadoSistema.anoAtual--;
        } else if (estadoSistema.mesAtual > 11) {
            estadoSistema.mesAtual = 0;
            estadoSistema.anoAtual++;
        }
        
        gerarCalendario();
        atualizarEstatisticas();
        
        console.log('📅 Mês alterado:', MESES[estadoSistema.mesAtual], estadoSistema.anoAtual);
    }

    function mostrarNovoEvento(data = null) {
        Notifications.info('Função de criação de evento em desenvolvimento...');
        console.log('📅 Criando evento para data:', data);
    }

    // ========== FUNÇÕES DE DASHBOARD ==========
    function atualizarEstatisticas() {
        if (!dados?.areas) return;
        
        let emDia = 0, atencao = 0, atraso = 0, total = 0;
        
        Object.values(dados.areas).forEach(area => {
            area.atividades?.forEach(atividade => {
                total++;
                switch(atividade.status) {
                    case 'verde': emDia++; break;
                    case 'amarelo': atencao++; break;
                    case 'vermelho': atraso++; break;
                }
            });
        });
        
        // Atualizar números
        document.getElementById('statEmDia').textContent = emDia;
        document.getElementById('statAtencao').textContent = atencao;
        document.getElementById('statAtraso').textContent = atraso;
        document.getElementById('statEventos').textContent = dados?.eventos?.length || 0;
        
        // Atualizar barras de progresso
        if (total > 0) {
            document.getElementById('progressEmDia').style.width = `${(emDia / total) * 100}%`;
            document.getElementById('progressAtencao').style.width = `${(atencao / total) * 100}%`;
            document.getElementById('progressAtraso').style.width = `${(atraso / total) * 100}%`;
        }
        
        console.log('📊 Estatísticas atualizadas:', { emDia, atencao, atraso, total });
    }

    function atualizarDataAtual() {
        const hoje = new Date();
        const elemento = document.getElementById('dataAtual');
        if (elemento) {
            elemento.textContent = hoje.toLocaleDateString('pt-BR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
    }

    function atualizarStatusSistema(elementId, texto, tipo = 'info') {
        const elemento = document.getElementById(elementId);
        if (elemento) {
            elemento.textContent = texto;
            elemento.style.color = tipo === 'success' ? '#10b981' : tipo === 'error' ? '#ef4444' : '#6b7280';
        }
    }

    // ========== INICIALIZAÇÃO PRINCIPAL ==========
    async function inicializarSistemaLogado() {
        console.log('🚀 Inicializando sistema logado...');
        
        // Esconder login e mostrar dashboard
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainContainer').classList.remove('hidden');
        
        // Atualizar informações do usuário
        if (usuarioAtual) {
            estadoSistema.usuarioEmail = usuarioAtual.email;
            estadoSistema.usuarioNome = usuarioAtual.displayName || usuarioAtual.email.split('@')[0];
            
            const usuarioInfo = document.getElementById('usuarioInfo');
            if (usuarioInfo) {
                usuarioInfo.textContent = `👤 ${estadoSistema.usuarioNome}`;
            }
            
            atualizarStatusSistema('statusUsuario', estadoSistema.usuarioNome, 'success');
        }
        
        // Atualizar data atual
        atualizarDataAtual();
        atualizarStatusSistema('statusSistema', 'Inicializado', 'success');
        
        // Carregar dados
        await carregarDados();
        
        // Gerar calendário
        gerarCalendario();
        
        // Atualizar estatísticas
        atualizarEstatisticas();
        
        console.log('✅ Sistema inicializado com sucesso!');
        Notifications.sucesso('Sistema carregado com sucesso!');
    }

    // ========== LISTENER DE AUTENTICAÇÃO ==========
    // Usar try-catch para lidar com possíveis problemas do Firebase
    try {
        firebase.auth().onAuthStateChanged((user) => {
            console.log('🔄 Estado de autenticação mudou:', user ? user.email : 'Nenhum usuário');
            
            if (user) {
                usuarioAtual = user;
                inicializarSistemaLogado();
            } else {
                usuarioAtual = null;
                // Mostrar login
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainContainer').classList.add('hidden');
            }
        });
    } catch (error) {
        console.error('❌ Erro no listener de autenticação:', error);
        // Sistema funcionará apenas com login demo
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('mainContainer').classList.add('hidden');
    }

    // ========== LISTENERS DE TECLADO ==========
    document.addEventListener('keydown', (e) => {
        // Enter no login
        if (e.key === 'Enter' && !document.getElementById('loginScreen').classList.contains('hidden')) {
            fazerLogin();
        }
    });

    // ========== INICIALIZAÇÃO ==========
    document.addEventListener('DOMContentLoaded', () => {
        console.log('🎯 DOM carregado - Sistema iniciando...');
        atualizarDataAtual();
        
        // Status inicial
        atualizarStatusSistema('statusSistema', 'Carregando...', 'info');
        atualizarStatusSistema('statusUsuario', 'Verificando...', 'info');
        atualizarStatusSistema('statusDados', 'Aguardando...', 'info');
        atualizarStatusSistema('statusCalendario', 'Aguardando...', 'info');
        
        // Preencher campos de demo automaticamente
        setTimeout(() => {
            const emailInput = document.getElementById('loginEmail');
            const senhaInput = document.getElementById('loginPassword');
            if (emailInput && senhaInput) {
                emailInput.value = 'demo@sistema.com';
                senhaInput.value = '123456';
            }
        }, 500);
    });

    // Exportar para debug
    window.Notifications = Notifications;
    window.estadoSistema = estadoSistema;
    window.dados = dados;
    window.usuarioAtual = usuarioAtual;
    window.loginDemo = loginDemo;
    window.testarFirebase = () => {
        firebase.database().ref('.info/connected').once('value', snapshot => {
            const connected = snapshot.val();
            console.log('🔥 Firebase conectado:', connected);
            Notifications.info(`Firebase: ${connected ? 'Conectado' : 'Desconectado'}`);
        }).catch(error => {
            console.error('❌ Erro ao testar Firebase:', error);
            Notifications.erro('Erro na conexão Firebase');
        });
    };
    
    console.log('✅ Sistema de Gestão v5.1 CORRIGIDO carregado!');
    </script>
</body>
</html>